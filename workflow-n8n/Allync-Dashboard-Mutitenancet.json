{
  "name": "Allync-Dashboard-Mutitenancet",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "evolution-webhook",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -2032,
        -16
      ],
      "id": "3f75bc40-5921-4fa3-9fc7-afb6af27ede8",
      "name": "Webhook_Listener",
      "webhookId": "9a9680a2-ae60-47bb-8823-5de4eedaa6b2"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "3b4dc488-9f5f-4107-9574-9a91bd356948",
              "leftValue": "={{ $json.body.data?.message?.conversation?.trim() || $json.body.data?.message?.extendedTextMessage?.text?.trim() || '' }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            },
            {
              "id": "5480ac58-4871-4153-abf9-65e97678127e",
              "leftValue": "",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1744,
        -16
      ],
      "id": "015e5d2f-fd44-45e5-a70d-d75ea0d3b386",
      "name": "FILTER"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.message_type }}",
                    "rightValue": "text",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "e7e745fa-fc53-4c69-8a00-44ee46cda8d6"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Text Message"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "86ae1c1e-4c43-40c8-a978-0515036b2a39",
                    "leftValue": "={{ $json.message_type }}",
                    "rightValue": "image",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Image"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "62aa50ef-cf16-457c-af64-26089bc4c71a",
                    "leftValue": "={{ $json.message_type }}",
                    "rightValue": "audio",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Audio/Voice"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "b11cc410-488a-486a-b59a-a1839177f897",
                    "leftValue": "={{ $json.message_type }}",
                    "rightValue": "document",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Document"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        1072,
        -64
      ],
      "id": "3acd0eb1-9bcf-454e-bcc9-d9159a515dc3",
      "name": "Switch"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "68e56cf7-271f-4abb-a155-40e746286bef",
              "leftValue": "={{ $json.userCount }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        2432,
        -528
      ],
      "id": "f1ffac16-4b8e-4f85-9985-02072ec6aa09",
      "name": "If"
    },
    {
      "parameters": {
        "tableId": "whatsapp_user_profiles",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "company_id",
              "fieldValue": "={{ $('DATA FORMATTER').item.json.company_id }}"
            },
            {
              "fieldId": "phone_number",
              "fieldValue": "={{ $('DATA FORMATTER').item.json.phone_number }}"
            },
            {
              "fieldId": "name",
              "fieldValue": "={{ $('DATA FORMATTER').item.json.sender_name }}"
            },
            {
              "fieldId": "last_seen",
              "fieldValue": "={{ $('DATA FORMATTER').item.json.timestamp }}"
            },
            {
              "fieldId": "created_at",
              "fieldValue": "={{ $('DATA FORMATTER').item.json.timestamp }}"
            },
            {
              "fieldId": "customer_status",
              "fieldValue": "new"
            },
            {
              "fieldId": "total_messages",
              "fieldValue": "1"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        2688,
        -368
      ],
      "id": "813cff20-b200-4547-9591-ba514bac8614",
      "name": "Create User",
      "credentials": {
        "supabaseApi": {
          "id": "SYQY7Y5p1hnytb5L",
          "name": "Supabase account 2"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        3136,
        -528
      ],
      "id": "3a3ea539-4000-4e77-ba8a-cd95aff4a6a5",
      "name": "Merge",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "jsCode": "const sessions = $input.all();\nconst now = new Date();\nconst thirtyMinutesAgo = new Date(now.getTime() - 30 * 60 * 1000);\n\n// Prepare Session Check'ten gelen veriler\nconst userData = $('Prepare Session Check').first().json;\n\n// Check Active Session'dan gelen veri yapÄ±sÄ±nÄ± kontrol et\nif (sessions && sessions.length > 0 && sessions[0].json) {\n    const sessionData = Array.isArray(sessions[0].json) ? sessions[0].json : [sessions[0].json];\n    \n    // sessionData boÅŸ array olabilir\n    if (sessionData.length > 0 && sessionData[0] && sessionData[0].id) {\n        const session = sessionData[0];\n        \n        // updated_at kontrolÃ¼\n        const lastUpdate = new Date(session.updated_at || session.session_start);\n        \n        // 30 dakika kontrolÃ¼\n        if (lastUpdate.getTime() > thirtyMinutesAgo.getTime()) {\n            return [{\n                json: {\n                    ...userData,\n                    has_active_session: true,\n                    session_id: session.id,\n                    session_data: session,\n                    sender: userData.phone_number,\n                    \n                    // âœ… YENÄ°: Session state bilgileri\n                    conversation_state: session.conversation_state || 'idle',\n                    state_data: session.state_data || {},\n                    collected_data: session.collected_data || {},\n                    last_intent: session.last_intent || null\n                }\n            }];\n        }\n    }\n}\n\n// Aktif session yok\nreturn [{\n    json: {\n        ...userData,\n        has_active_session: false,\n        session_id: null,\n        sender: userData.phone_number,\n        \n        // âœ… YENÄ°: VarsayÄ±lan state (yeni session)\n        conversation_state: 'idle',\n        state_data: {},\n        collected_data: {},\n        last_intent: null\n    }\n}];\n\n// Mevcut koda EKLE (en sona)\n\n// ============================================================\n// CHECK INTEGRATIONS (YENÄ°)\n// ============================================================\n\nconst sheetsEnabled = await $supabase\n  .rpc('check_sheets_enabled', { p_company_id: companyId })\n  .single();\n\nconst calendarEnabled = await $supabase\n  .rpc('check_calendar_enabled', { p_company_id: companyId })\n  .single();\n\nreturn {\n  json: {\n    ...data,\n    sheets_enabled: sheetsEnabled?.data || false,\n    calendar_enabled: calendarEnabled?.data || false\n  }\n};\n// ============================================================\n// CHECK INTEGRATIONS (SHEETS & CALENDAR)\n// ============================================================\n\nconst checkSheets = await $supabase\n  .from('sheets_instances')\n  .select('id')\n  .eq('company_id', companyId)\n  .eq('status', 'active')\n  .eq('is_primary', true)\n  .limit(1);\n\nconst checkCalendar = await $supabase\n  .from('calendar_instances')\n  .select('id')\n  .eq('company_id', companyId)\n  .eq('status', 'active')\n  .eq('is_primary', true)\n  .limit(1);\n\nreturn {\n  json: {\n    ...normalizedData,\n    sheets_enabled: (checkSheets.data && checkSheets.data.length > 0),\n    calendar_enabled: (checkCalendar.data && checkCalendar.data.length > 0)\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4160,
        -528
      ],
      "id": "1ad7bba4-adca-4904-94f9-439edc42a8bc",
      "name": "Session Validator"
    },
    {
      "parameters": {
        "tableId": "whatsapp_sessions",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "company_id",
              "fieldValue": "={{ $('Prepare Session Check').item.json.company_id }}"
            },
            {
              "fieldId": "user_id",
              "fieldValue": "={{ $('IF2').item.json.user_id }}"
            },
            {
              "fieldId": "sender",
              "fieldValue": "={{ $('IF2').item.json.phone_number }}"
            },
            {
              "fieldId": "customer_name",
              "fieldValue": "={{ $('IF2').item.json.name }}"
            },
            {
              "fieldId": "customer_phone",
              "fieldValue": "={{ $('IF2').item.json.phone_number }}"
            },
            {
              "fieldId": "session_start",
              "fieldValue": "={{ $now }}"
            },
            {
              "fieldId": "is_active",
              "fieldValue": "true"
            },
            {
              "fieldId": "context",
              "fieldValue": "={{ JSON.stringify({ messages: [], user_name: $('IF2').item.json.sender_name }) }}"
            },
            {
              "fieldId": "status",
              "fieldValue": "active"
            },
            {
              "fieldId": "message_count",
              "fieldValue": "0"
            },
            {
              "fieldId": "unread_count",
              "fieldValue": "0"
            },
            {
              "fieldId": "created_at",
              "fieldValue": "={{ $now }}"
            },
            {
              "fieldId": "updated_at",
              "fieldValue": "={{ $now }}"
            },
            {
              "fieldId": "conversation_state",
              "fieldValue": "idle"
            },
            {
              "fieldId": "state_data",
              "fieldValue": "={{ JSON.stringify({}) }}"
            },
            {
              "fieldId": "collected_data",
              "fieldValue": "={{ JSON.stringify({}) }}"
            },
            {
              "fieldId": "last_intent",
              "fieldValue": "\"\""
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        5040,
        -336
      ],
      "id": "13e89e96-3697-4e80-825d-0fd7f7782e23",
      "name": "Create New Session",
      "alwaysOutputData": false,
      "credentials": {
        "supabaseApi": {
          "id": "SYQY7Y5p1hnytb5L",
          "name": "Supabase account 2"
        }
      },
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        5504,
        -528
      ],
      "id": "d5de176e-b564-4fd3-9756-7abb535bef0d",
      "name": "Merge2"
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "whatsapp_messages",
        "limit": 20,
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "keyName": "company_id",
              "condition": "eq",
              "keyValue": "={{ $('DATA FORMATTER').item.json.company_id }}"
            },
            {
              "keyName": "session_id",
              "condition": "eq",
              "keyValue": "={{ $json.session_id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        6272,
        -544
      ],
      "id": "ba1845d3-61e0-4072-a7e9-0871600579ee",
      "name": "Get Last Messages",
      "alwaysOutputData": false,
      "credentials": {
        "supabaseApi": {
          "id": "SYQY7Y5p1hnytb5L",
          "name": "Supabase account 2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Context Builder - PROFESYONEL VERSÄ°YON + AI SETTINGS + VIP USER + STATE MANAGEMENT\n// Ä°lk mesaj veya conversation history fark etmez, her durumda Ã§alÄ±ÅŸÄ±r\nconst input = $input.first().json;\n\n// ============================================================\n// TEMEL BÄ°LGÄ°LER\n// ============================================================\n\nconst currentMessage = input.message_body || '';\nconst senderName = input.sender_name || 'User';\nconst phoneNumber = input.phone_number || '';\nconst instanceId = input.instance_id || '';\nconst userId = input.user_id || '';\nconst sessionId = input.session_id || '';\nconst companyId = input.company_id || '';\n\n// ============================================================\n// API KEYS & CONFIG (MULTI-TENANT)\n// ============================================================\n\nconst geminiApiKey = input.gemini_api_key || '';\nconst aiSystemPrompt = input.ai_system_prompt || '';\nconst evolutionApiUrl = input.evolution_api_url || '';\nconst evolutionApiKey = input.evolution_api_key || '';\nconst instanceName = input.instance_name || '';\n\n// ============================================================\n// USER STATS\n// ============================================================\n\nconst totalMessages = input.total_messages || 0;\nconst customerStatus = input.customer_status || 'new';\n\n// ============================================================\n// TARÄ°H VE ZAMAN\n// ============================================================\n\nconst now = new Date();\nconst year = now.getFullYear();\nconst month = now.toLocaleDateString('tr-TR', { month: 'long' });\nconst day = now.getDate();\nconst dayOfWeek = now.toLocaleDateString('tr-TR', { weekday: 'long' });\nconst hour = now.getHours();\nconst minute = String(now.getMinutes()).padStart(2, '0');\nconst fullDate = `${day} ${month} ${year}`;\nconst fullDateTime = `${day} ${month} ${year} ${dayOfWeek} ${hour}:${minute}`;\n\nlet timeOfDay = '';\nif (hour >= 6 && hour < 12) timeOfDay = 'Sabah';\nelse if (hour >= 12 && hour < 17) timeOfDay = 'Ã–ÄŸleden sonra';\nelse if (hour >= 17 && hour < 21) timeOfDay = 'AkÅŸam';\nelse timeOfDay = 'Gece';\n\n// ============================================================\n// CONVERSATION CONTEXT\n// ============================================================\n\nconst conversationHistory = input.conversationHistory || [];\nlet contextLines = [];\n\n// EÄŸer geÃ§miÅŸ varsa\nif (conversationHistory.length > 0) {\n    // Son 10 mesajÄ± al ve formatla\n    const recent = conversationHistory.slice(-10);\n    \n    for (const msg of recent) {\n        const owner = msg.message_owner === 'bot' \n            ? 'Allync AI' \n            : (msg.sender_name || 'User');\n        \n        const prefix = msg.message_owner === 'bot' ? 'ðŸ¤–' : 'ðŸ‘¤';\n        contextLines.push(`${prefix} ${owner}: ${msg.message_body}`);\n    }\n}\n\n// Åžu anki mesajÄ± context'e ekle\ncontextLines.push(`ðŸ‘¤ ${senderName}: ${currentMessage}`);\n\n// Final context\nconst finalContext = contextLines.join('\\n');\n\n// ============================================================\n// AI SETTINGS PARSE\n// ============================================================\n\nconst aiSettings = input.ai_settings || {};\n\n// Åžirket kimliÄŸi\nconst companyIdentity = aiSettings.company_identity || {};\nconst companyName = companyIdentity.name || input.company_name || 'Bilinmiyor';\nconst greeting = companyIdentity.greeting || 'Merhaba! Size nasÄ±l yardÄ±mcÄ± olabilirim?';\nconst farewell = companyIdentity.farewell || 'Ä°yi gÃ¼nler dilerim!';\nconst personality = companyIdentity.personality || 'friendly';\n\n// Ä°zin verilen Ã¶zellikler\nconst allowedFeatures = aiSettings.allowed_features || {\n  general_chat: true,\n  price_query: true,\n  appointment: true,\n  product_info: true,\n  stock_check: false,\n  document_request: false,\n  complaint_handling: true\n};\n\n// Dil ayarlarÄ±\nconst languageSettings = aiSettings.language_detection || {\n  enabled: true,\n  supported: ['tr', 'en', 'ar'],\n  default: 'tr',\n  respond_in_detected_language: true\n};\n\n// KÄ±sÄ±tlamalar\nconst restrictions = aiSettings.restrictions || {\n  stay_on_topic: false,\n  block_offensive_words: true,\n  allowed_topics: [],\n  blocked_topics: []\n};\n\n// Response style\nconst responseStyle = aiSettings.response_style || {\n  tone: 'friendly',\n  max_length: 300,\n  use_emojis: true,\n  formality_level: 'casual'\n};\n\n// Intent handling\nconst intentHandling = aiSettings.intent_handling || {\n  confidence_threshold: 0.7,\n  fallback_to_human: false,\n  max_retries: 2\n};\n\n// Sheets integration\nconst sheetsIntegration = aiSettings.sheets_integration || {\n  enabled: true,\n  default_sheet_id: null,\n  max_results: 5\n};\n\n// Calendar integration\nconst calendarIntegration = aiSettings.calendar_integration || {\n  enabled: true,\n  default_calendar_id: null,\n  require_confirmation: true\n};\n\n// ============================================================\n// VIP/PRIVILEGED USER BÄ°LGÄ°LERÄ°\n// ============================================================\n\nconst isPrivilegedUser = input.is_privileged || false;\nconst privilegeLevel = input.privilege_level || 'customer';\nconst greetingName = input.greeting_name || null;\nconst privilegedFeatures = input.privileged_allowed_features || {};\n\n// ============================================================\n// CONVERSATION STATE (Multi-turn conversation desteÄŸi)\n// ============================================================\n\nconst conversationState = input.conversation_state || 'idle';\nconst stateData = input.state_data || {};\nconst collectedData = input.collected_data || {};\nconst lastIntent = input.last_intent || null;\n\n// ============================================================\n// OUTPUT - RETURN DATA\n// ============================================================\n\nreturn [{\n    json: {\n        // ============================================================\n        // CONTEXT & MESSAGE\n        // ============================================================\n        context: finalContext,\n        current_message: currentMessage,\n        \n        // ============================================================\n        // USER INFO\n        // ============================================================\n        sender_name: senderName,\n        phone_number: phoneNumber,\n        user_id: userId,\n        total_messages: totalMessages,\n        customer_status: customerStatus,\n        \n        // ============================================================\n        // SESSION INFO\n        // ============================================================\n        session_id: sessionId,\n        instance_id: instanceId,\n        company_id: companyId,\n        \n        // ============================================================\n        // MESSAGE STATS\n        // ============================================================\n        message_count: conversationHistory.length,\n        has_history: conversationHistory.length > 0,\n        \n        // ============================================================\n        // TARÄ°H BÄ°LGÄ°LERÄ°\n        // ============================================================\n        current_date: fullDate,\n        current_datetime: fullDateTime,\n        day_of_week: dayOfWeek,\n        time_of_day: timeOfDay,\n        current_hour: hour,\n        current_minute: minute,\n        year: year,\n        month: month,\n        day: day,\n        \n        // ============================================================\n        // API KEYS & CONFIG (DYNAMIC MULTI-TENANT)\n        // ============================================================\n        gemini_api_key: geminiApiKey,\n        ai_system_prompt: aiSystemPrompt,\n        evolution_api_url: evolutionApiUrl,\n        evolution_api_key: evolutionApiKey,\n        instance_name: instanceName,\n        \n        // ============================================================\n        // COMPANY IDENTITY\n        // ============================================================\n        company_name: companyName,\n        company_greeting: greeting,\n        company_farewell: farewell,\n        personality: personality,\n        \n        // ============================================================\n        // ALLOWED FEATURES\n        // ============================================================\n        allowed_features: allowedFeatures,\n        feature_general_chat: allowedFeatures.general_chat,\n        feature_price_query: allowedFeatures.price_query,\n        feature_appointment: allowedFeatures.appointment,\n        feature_product_info: allowedFeatures.product_info,\n        feature_stock_check: allowedFeatures.stock_check,\n        feature_document_request: allowedFeatures.document_request,\n        feature_complaint_handling: allowedFeatures.complaint_handling,\n        \n        // ============================================================\n        // LANGUAGE SETTINGS\n        // ============================================================\n        language_settings: languageSettings,\n        supported_languages: languageSettings.supported,\n        default_language: languageSettings.default,\n        respond_in_detected_language: languageSettings.respond_in_detected_language,\n        \n        // ============================================================\n        // RESTRICTIONS\n        // ============================================================\n        restrictions: restrictions,\n        stay_on_topic: restrictions.stay_on_topic,\n        block_offensive_words: restrictions.block_offensive_words,\n        allowed_topics: restrictions.allowed_topics,\n        blocked_topics: restrictions.blocked_topics,\n        \n        // ============================================================\n        // RESPONSE STYLE\n        // ============================================================\n        response_style: responseStyle,\n        response_tone: responseStyle.tone,\n        use_emojis: responseStyle.use_emojis,\n        max_response_length: responseStyle.max_length,\n        formality_level: responseStyle.formality_level,\n        \n        // ============================================================\n        // INTENT HANDLING\n        // ============================================================\n        intent_confidence_threshold: intentHandling.confidence_threshold,\n        fallback_to_human: intentHandling.fallback_to_human,\n        max_retries: intentHandling.max_retries,\n        \n        // ============================================================\n        // INTEGRATIONS\n        // ============================================================\n        sheets_enabled: sheetsIntegration.enabled,\n        sheets_default_id: sheetsIntegration.default_sheet_id,\n        sheets_max_results: sheetsIntegration.max_results,\n        \n        calendar_enabled: calendarIntegration.enabled,\n        calendar_default_id: calendarIntegration.default_calendar_id,\n        calendar_require_confirmation: calendarIntegration.require_confirmation,\n        \n        // ============================================================\n        // VIP/PRIVILEGED USER\n        // ============================================================\n        is_privileged_user: isPrivilegedUser,\n        privilege_level: privilegeLevel,\n        greeting_name: greetingName,\n        privileged_allowed_features: privilegedFeatures,\n        \n        // ============================================================\n        // CONVERSATION STATE (Multi-turn conversation)\n        // ============================================================\n        conversation_state: conversationState,\n        state_data: stateData,\n        collected_data: collectedData,\n        last_intent: lastIntent,\n        \n        // ============================================================\n        // FULL AI SETTINGS (BACKUP)\n        // ============================================================\n        ai_settings: aiSettings,\n        // âœ… YENÄ°: Entegrasyon durumlarÄ±\n        sheets_enabled: input.sheets_enabled || false,\n        calendar_enabled: input.calendar_enabled || false\n    }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6704,
        -544
      ],
      "id": "924d0f05-65b2-47c8-a735-b1a0efe1462e",
      "name": "Context Builder"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "3496b8ba-dc66-4013-97ea-69be22e08c11",
              "name": "ai_response",
              "value": "={{ $json.bot_response }}",
              "type": "string"
            },
            {
              "id": "d6335c8e-1a33-4ea4-b2f6-db695ce0f170",
              "name": "user_message_id",
              "value": "={{ $now.toString() + '_user' }}",
              "type": "string"
            },
            {
              "id": "563f9ad1-3340-4acc-bca8-8c1303980c7e",
              "name": "bot_message_id",
              "value": "={{ $now.toString() + '_bot' }}",
              "type": "string"
            },
            {
              "id": "12465fea-3f17-4a80-bcc6-14bd00452a5e",
              "name": "session_id",
              "value": "={{ $('Context Builder').item.json.session_id }}",
              "type": "string"
            },
            {
              "id": "0ea4fe37-37b8-4c84-b6ef-4a635d4fc152",
              "name": "user_id",
              "value": "={{ $('Context Builder').item.json.user_id }}",
              "type": "string"
            },
            {
              "id": "5501e043-a657-4b8f-9b70-10640aa8720f",
              "name": "instance_id",
              "value": "={{ $('Context Builder').item.json.instance_id }}",
              "type": "string"
            },
            {
              "id": "b438e2fe-088e-4bd1-a18a-b8d46ff46187",
              "name": "phone_number",
              "value": "={{ $('Context Builder').item.json.phone_number }}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        8512,
        384
      ],
      "id": "ebe52ee1-89ee-4159-9c39-a954be36fc19",
      "name": "Format Response"
    },
    {
      "parameters": {
        "tableId": "whatsapp_messages",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "sender",
              "fieldValue": "=customer"
            },
            {
              "fieldId": "message_body",
              "fieldValue": "={{ $('Session Validator').item.json.message_body }}"
            },
            {
              "fieldId": "message_owner",
              "fieldValue": "user"
            },
            {
              "fieldId": "message_type",
              "fieldValue": "text"
            },
            {
              "fieldId": "instance_id",
              "fieldValue": "={{ $('Merge2').item.json.instance_id }}"
            },
            {
              "fieldId": "created_at",
              "fieldValue": "={{ new Date().toISOString() }}"
            },
            {
              "fieldId": "user_id",
              "fieldValue": "={{ $json.user_id }}"
            },
            {
              "fieldId": "sender_name",
              "fieldValue": "={{ $json.sender_name }}"
            },
            {
              "fieldId": "session_id",
              "fieldValue": "={{ $json.session_id }}"
            },
            {
              "fieldId": "company_id",
              "fieldValue": "={{ $('DATA FORMATTER').item.json.company_id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        5968,
        -528
      ],
      "id": "bb2ce717-e2ba-4879-a563-f98362ccc298",
      "name": "Save User Message",
      "credentials": {
        "supabaseApi": {
          "id": "SYQY7Y5p1hnytb5L",
          "name": "Supabase account 2"
        }
      },
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "tableId": "whatsapp_messages",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "sender",
              "fieldValue": "=bot"
            },
            {
              "fieldId": "sender_name",
              "fieldValue": "agent"
            },
            {
              "fieldId": "message_body",
              "fieldValue": "={{ $json.ai_response }}"
            },
            {
              "fieldId": "message_owner",
              "fieldValue": "bot"
            },
            {
              "fieldId": "message_type",
              "fieldValue": "text"
            },
            {
              "fieldId": "instance_id",
              "fieldValue": "={{ $json.instance_id }}"
            },
            {
              "fieldId": "created_at",
              "fieldValue": "={{ new Date().toISOString() }}"
            },
            {
              "fieldId": "user_id",
              "fieldValue": "={{ $json.user_id.toString() }}"
            },
            {
              "fieldId": "session_id",
              "fieldValue": "={{ $json.session_id.toString() }}"
            },
            {
              "fieldId": "company_id",
              "fieldValue": "={{ $('Inject IDs').item.json.company_id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        8784,
        384
      ],
      "id": "30f0638b-cd84-4247-ad68-70c09674bd17",
      "name": "Save Bot Response",
      "credentials": {
        "supabaseApi": {
          "id": "SYQY7Y5p1hnytb5L",
          "name": "Supabase account 2"
        }
      },
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "user_profiles",
        "filters": {
          "conditions": [
            {
              "keyName": "phone_number",
              "condition": "eq",
              "keyValue": "={{ $('Context Builder').item.json.phone_number }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "last_seen",
              "fieldValue": "={{ new Date().toISOString() }}"
            },
            {
              "fieldId": "total_messages",
              "fieldValue": "={{ parseInt($json.total_messages || 0) + 1 }}"
            },
            {
              "fieldId": "customer_status",
              "fieldValue": "={{ parseInt($json.total_messages || 0) >= 4 ? \"old\" : \"new\" }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        9296,
        368
      ],
      "id": "9b41f1d7-88e0-4006-87ff-812deff0a362",
      "name": "Update User Stats",
      "credentials": {
        "supabaseApi": {
          "id": "YWr0zYtmMCKrbiNV",
          "name": "Supabase account"
        }
      },
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "whatsapp_sessions",
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "keyName": "id",
              "condition": "eq",
              "keyValue": "={{ $('Context Builder').item.json.session_id }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "conversation_state",
              "fieldValue": "={{ $('Parse Gemini Response').item.json.next_state }}"
            },
            {
              "fieldId": "collected_data",
              "fieldValue": "={{ JSON.stringify($('Parse Gemini Response').item.json.collected_data) }}"
            },
            {
              "fieldId": "last_intent",
              "fieldValue": "={{ $('Parse Gemini Response').item.json.detected_intent }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        10400,
        352
      ],
      "id": "ba41ac2c-3a80-462c-be75-c08c7f9daa54",
      "name": "Update Session",
      "alwaysOutputData": false,
      "credentials": {
        "supabaseApi": {
          "id": "SYQY7Y5p1hnytb5L",
          "name": "Supabase account 2"
        }
      },
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "jsCode": "// CHECK USER'dan gelen user verisi\nconst checkUserData = $('CHECK USER').first().json;\n\n// Check Privileged User'dan gelen VIP verisi\nconst privilegedData = $('Check Privileged User').first().json[0] || {\n  is_privileged: false,\n  privilege_level: 'customer',\n  greeting_name: null,\n  allowed_features: {}\n};\n\n// User count hesapla\nlet userCount = 0;\nlet userData = {};\n\nif (Array.isArray(checkUserData) && checkUserData.length > 0) {\n    userCount = checkUserData.length;\n    userData = checkUserData[0];\n} else if (checkUserData.id) {\n    userCount = 1;\n    userData = checkUserData;\n}\n\n// DATA FORMATTER'dan gelen orijinal veriyi al\nconst originalData = $input.item.json;\n\n// HEPSÄ°NÄ° BÄ°RLEÅžTÄ°R\nreturn [{\n    json: {\n        ...originalData,      // Orijinal veri (phone, company_id, etc.)\n        ...userData,          // User profili (id, total_messages, etc.)\n        userCount: userCount, // User var mÄ± kontrolÃ¼\n        \n        // âœ… YENÄ°: Privileged user bilgileri\n        is_privileged: privilegedData.is_privileged,\n        privilege_level: privilegedData.privilege_level,\n        greeting_name: privilegedData.greeting_name,\n        privileged_allowed_features: privilegedData.allowed_features\n    }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2176,
        -528
      ],
      "id": "eeeb2aea-1806-42d4-ae13-afc2752a37b7",
      "name": "Code: Count_Items"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "fc7a929d-4724-4fe6-a0d9-f37a76610d25",
              "name": "user_id",
              "value": "={{ $('Merge').item.json.id }}",
              "type": "string"
            },
            {
              "id": "665ac50c-7221-4162-8184-2bb529fc0454",
              "name": "phone_number",
              "value": "={{ $('DATA FORMATTER').item.json.phone_number }}",
              "type": "string"
            },
            {
              "id": "5a3c06c9-8123-4e9a-9794-c732ef70a867",
              "name": "sender_name",
              "value": "={{ $('DATA FORMATTER').item.json.sender_name }}",
              "type": "string"
            },
            {
              "id": "2bfdcada-088a-4d74-943f-d244aa632263",
              "name": "instance_id",
              "value": "={{ $('DATA FORMATTER').item.json.instance_id }}",
              "type": "string"
            },
            {
              "id": "804b0eb5-512c-4296-87ee-ecd15a7abf01",
              "name": "message_body",
              "value": "={{ $('DATA FORMATTER').item.json.message_body }}",
              "type": "string"
            },
            {
              "id": "c3584bd3-91da-44f4-bfdd-ab7d79049908",
              "name": "total_messages",
              "value": "={{ $('Merge').item.json.total_messages || 0 }}",
              "type": "string"
            },
            {
              "id": "93e7d6a1-2fa6-4d79-8d30-0e8ca75af50e",
              "name": "customer_status",
              "value": "={{ $('Merge').item.json.customer_status || 'new' }}",
              "type": "string"
            },
            {
              "id": "41379ff8-cdbd-47d7-be24-088209f4ac98",
              "name": "gemini_api_key",
              "value": "={{ $('DATA FORMATTER').item.json.gemini_api_key }}",
              "type": "string"
            },
            {
              "id": "8c24842e-61ed-4ee7-a01d-d5fe610fb9db",
              "name": "evolution_api_url",
              "value": "={{ $('DATA FORMATTER').item.json.evolution_api_url }}",
              "type": "string"
            },
            {
              "id": "d8d38e9f-d2a7-4034-9627-aedd6ef0dfd6",
              "name": "evolution_api_key",
              "value": "={{ $('DATA FORMATTER').item.json.evolution_api_key }}",
              "type": "string"
            },
            {
              "id": "302ef7af-a203-4ebb-9808-ebccf3d2c0c0",
              "name": "instance_name",
              "value": "={{ $('DATA FORMATTER').item.json.instance_name }}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        3344,
        -528
      ],
      "id": "6dd90ee9-bbde-405c-892d-8a1cb7594596",
      "name": "Prepare Session Check"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "13f82a80-3d10-4786-835e-7c6b9f0a17e1",
              "leftValue": "={{ $json.has_active_session }}",
              "rightValue": "=true",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        4352,
        -528
      ],
      "id": "c8eca5f6-cb8a-48e2-b53e-d3567ae043c8",
      "name": "IF2"
    },
    {
      "parameters": {
        "amount": 1
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        2896,
        -368
      ],
      "id": "a7664437-e6fb-4f55-a38a-556137340abb",
      "name": "Wait",
      "webhookId": "1d558743-000c-40b1-843d-c0e0e5e2c7f5"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        10656,
        336
      ],
      "id": "db13e564-8808-4bb7-9835-b83de372ade8",
      "name": "Respond to Webhook"
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "whatsapp_sessions",
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "keyName": "company_id",
              "condition": "eq",
              "keyValue": "={{ $('Prepare Session Check').item.json.company_id }}"
            },
            {
              "keyName": "is_active",
              "condition": "eq",
              "keyValue": "true"
            },
            {
              "keyName": "user_id",
              "condition": "eq",
              "keyValue": "={{ $json.user_id }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "is_active",
              "fieldValue": "false"
            },
            {
              "fieldId": "session_end",
              "fieldValue": "=={{ $now }}"
            },
            {
              "fieldId": "status",
              "fieldValue": "closed"
            },
            {
              "fieldId": "updated_at",
              "fieldValue": "=={{ $now }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        4704,
        -336
      ],
      "id": "d7729cd7-a854-4664-91bd-2ba03a458750",
      "name": "Close Old Sessions",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "SYQY7Y5p1hnytb5L",
          "name": "Supabase account 2"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "29a58bf0-d5f4-4129-b4a2-120325843b62",
              "name": "session_id",
              "value": "={{ $json.session_id || $json.id }}",
              "type": "string"
            },
            {
              "id": "d9994e4a-d677-4efc-8676-20742a52e959",
              "name": "total_messages",
              "value": "={{ $('Session Validator').item.json.total_messages }}",
              "type": "string"
            },
            {
              "id": "4dc23dca-fabc-422d-8c8d-2f3ce6efe173",
              "name": "customer_status",
              "value": "={{ $('Session Validator').item.json.customer_status }}",
              "type": "string"
            },
            {
              "id": "b71f3d4f-e192-4fc9-b9cd-cea32e306cd8",
              "name": "sender_name",
              "value": "={{ $('Session Validator').item.json.sender_name }}",
              "type": "string"
            },
            {
              "id": "b29138bb-6de1-47f3-b3d4-aaf9e8b76179",
              "name": "sender",
              "value": "={{ $json.sender }}",
              "type": "string"
            },
            {
              "id": "e3877656-a217-4e1d-8499-8b9ddb3b7219",
              "name": "message_body",
              "value": "={{ $('Session Validator').item.json.message_body }}",
              "type": "string"
            },
            {
              "id": "f79be6c4-5ba3-4c66-82d8-747bc956eb2f",
              "name": "gemini_api_key",
              "value": "={{ $('DATA FORMATTER').item.json.gemini_api_key }}",
              "type": "string"
            },
            {
              "id": "89015936-5d8a-4e12-9b65-723c120ea7a7",
              "name": "ai_system_prompt",
              "value": "={{ $('DATA FORMATTER').item.json.ai_system_prompt }}",
              "type": "string"
            },
            {
              "id": "4f5dfaa0-9b53-4433-8b59-7685656db3e8",
              "name": "company_id",
              "value": "={{ $('DATA FORMATTER').item.json.company_id }}",
              "type": "string"
            },
            {
              "id": "60527d9c-1bfe-4fb5-9301-a6997dfd0663",
              "name": "conversation_state",
              "value": "={{ $json.conversation_state || 'idle' }}",
              "type": "string"
            },
            {
              "id": "ba44d7e5-7a0c-4f3c-9c1c-39e7f22e6b88",
              "name": "state_data",
              "value": "={{ $json.state_data || {} }}",
              "type": "object"
            },
            {
              "id": "60079ff0-ede2-4e0c-9be1-999a23440667",
              "name": "collected_data",
              "value": "={{ $json.collected_data || {} }}",
              "type": "object"
            },
            {
              "id": "5b7ee9f9-5c78-4189-9f2f-8002ff06e518",
              "name": "last_intent",
              "value": "={{ $json.last_intent || null }}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        5728,
        -528
      ],
      "id": "9e431db6-cbde-43ec-b440-b57672e1769d",
      "name": "Normalize Session ID"
    },
    {
      "parameters": {
        "jsCode": "const item = $input.item.json;\n\nconsole.log('=== CHECK ACTIVE SESSION INPUT ===');\nconsole.log('Phone Number:', item.phone_number);\nconsole.log('User ID:', item.user_id);\nconsole.log('Sender Name:', item.sender_name);\nconsole.log('Execution:', $execution.id);\nconsole.log('Timestamp:', new Date().toISOString());\nconsole.log('================================\\n');\n\nreturn [$input.item];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3536,
        -528
      ],
      "id": "83e142ae-bc48-4a01-8912-644f3e573fd0",
      "name": "Debug Session Input"
    },
    {
      "parameters": {
        "jsCode": "const sessionResult = $input.item.json;\nconst prepareData = $('Prepare Session Check').item.json;\n\nconsole.log('=== CHECK ACTIVE SESSION OUTPUT ===');\nconsole.log('Input phone_number:', prepareData.phone_number);\nconsole.log('Input user_id:', prepareData.user_id);\nconsole.log('---');\n\nif (Array.isArray(sessionResult)) {\n    console.log('Found sessions:', sessionResult.length);\n    sessionResult.forEach((session, i) => {\n        console.log(`Session ${i}:`, {\n            id: session.id,\n            sender: session.sender,\n            user_id: session.user_id,\n            is_active: session.is_active\n        });\n    });\n} else if (sessionResult.id) {\n    console.log('Found 1 session:', {\n        id: sessionResult.id,\n        sender: sessionResult.sender,\n        user_id: sessionResult.user_id\n    });\n} else {\n    console.log('NO SESSIONS FOUND (should create new)');\n}\nconsole.log('===================================\\n');\n\nreturn [$input.item];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3952,
        -528
      ],
      "id": "309826f4-9482-4fa3-b902-525d0e7dae13",
      "name": "Debug Session output"
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "whatsapp_sessions",
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "keyName": "company_id",
              "condition": "eq",
              "keyValue": "={{ $('Prepare Session Check').item.json.company_id }}"
            },
            {
              "keyName": "user_id",
              "condition": "eq",
              "keyValue": "={{ $('Prepare Session Check').item.json.user_id }}"
            },
            {
              "keyName": "sender",
              "condition": "eq",
              "keyValue": "={{ $('Prepare Session Check').item.json.phone_number }}"
            },
            {
              "keyName": "is_active",
              "condition": "eq",
              "keyValue": "true"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        3744,
        -528
      ],
      "id": "489fd223-bd26-4e8c-997d-91aeb1e50985",
      "name": "Check Active Session",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "SYQY7Y5p1hnytb5L",
          "name": "Supabase account 2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Inject IDs - FÄ°NAL VERSÄ°YON (TÃ¼m Dynamic Fieldlar)\n\nconst normalizedData = $('Normalize Session ID').item.json;\nconst savedMessage = $('Save User Message').item.json;\nconst currentMessageId = savedMessage.id;\nconst allMessages = $input.all();\n\n// âœ… DATA FORMATTER'dan direkt al\nconst companyId = $('DATA FORMATTER').item.json.company_id;\nconst evolutionApiUrl = $('DATA FORMATTER').item.json.evolution_api_url;\nconst evolutionApiKey = $('DATA FORMATTER').item.json.evolution_api_key;\nconst instanceName = $('DATA FORMATTER').item.json.instance_name;\n\nconst baseData = {\n    // Core IDs\n    company_id: companyId,\n    user_id: savedMessage.user_id,\n    session_id: savedMessage.session_id,\n    \n    // User Info\n    phone_number: normalizedData.sender,\n    sender_name: normalizedData.sender_name,\n    instance_id: normalizedData.instance_id,\n    message_body: normalizedData.message_body,\n    total_messages: normalizedData.total_messages || 0,\n    customer_status: normalizedData.customer_status || 'new',\n    \n    // API Keys & Config\n    gemini_api_key: normalizedData.gemini_api_key,\n    ai_system_prompt: normalizedData.ai_system_prompt,\n    evolution_api_url: evolutionApiUrl,\n    evolution_api_key: evolutionApiKey,\n    instance_name: instanceName\n};\n\nconst conversationHistory = allMessages\n    .filter(item => \n        item.json && \n        item.json.id && \n        item.json.id !== currentMessageId && \n        item.json.message_body\n    )\n    .map(item => ({\n        id: item.json.id,\n        sender: item.json.sender,\n        sender_name: item.json.sender_name || 'Unknown',\n        message_body: item.json.message_body,\n        message_owner: item.json.message_owner,\n        created_at: item.json.created_at\n    }));\n\nreturn [{\n    json: {\n        ...baseData,\n        conversationHistory: conversationHistory,\n        has_history: conversationHistory.length > 0,\n        current_message_id: currentMessageId,\n        sheets_enabled: normalizedData.sheets_enabled || false,\n        calendar_enabled: normalizedData.calendar_enabled || false\n    }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6496,
        -544
      ],
      "id": "3503033a-a4e4-486e-8e2f-fbf0454f1e3f",
      "name": "Inject IDs"
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "whatsapp_instances",
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "keyName": "instance_id",
              "condition": "eq",
              "keyValue": "={{ $json.body.instance }}"
            },
            {
              "keyName": "status",
              "condition": "eq",
              "keyValue": "active"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        512,
        -32
      ],
      "id": "86daf57d-0283-4bdf-84be-398af4079a3f",
      "name": "Get Company & Instance",
      "alwaysOutputData": false,
      "credentials": {
        "supabaseApi": {
          "id": "SYQY7Y5p1hnytb5L",
          "name": "Supabase account 2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Get webhook data by node name\nconst webhook = $('Webhook_Listener').first().json;\nconst eventData = webhook.body.data;\n\n// Get company data from previous node\nconst companyData = $input.first().json;\n\n// Extract phone number\nconst remoteJid = eventData.key.remoteJid;\nconst phoneNumber = remoteJid.replace('@s.whatsapp.net', '');\n\n// âœ… Extract sender name (pushName)\nconst senderName = eventData.pushName || phoneNumber;  // Yoksa telefon kullan\n\n// Extract message\nconst messageBody = eventData.message?.conversation || \n                   eventData.message?.extendedTextMessage?.text || \n                   'No message';\n\n// Determine message type\nlet messageType = 'text';\nif (eventData.message?.imageMessage) {\n  messageType = 'image';\n} else if (eventData.message?.audioMessage) {\n  messageType = 'audio';\n} else if (eventData.message?.documentMessage) {\n  messageType = 'document';\n}\n\n// Format output with company_id\nreturn [{\n  json: {\n    // Company Info\n    company_id: companyData.company_id,\n    instance_id: companyData.instance_id,\n    instance_name: companyData.instance_name,\n    \n    // User Info\n    phone_number: phoneNumber,\n    remote_jid: remoteJid,\n    sender_name: senderName,  // âœ… YENÄ° EKLENEN\n    \n    // Message Info\n    message_body: messageBody,\n    message_type: messageType,\n    message_id: eventData.key.id,\n    from_me: eventData.key.fromMe,\n    timestamp: new Date().toISOString(),\n    \n    // API Keys\n    evolution_api_url: companyData.evolution_api_url,\n    evolution_api_key: companyData.evolution_api_key,\n    gemini_api_key: companyData.gemini_api_key,\n    ai_system_prompt: companyData.ai_system_prompt\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        784,
        -32
      ],
      "id": "ae4a6f1c-3b9b-442c-b1ec-c8beaa8e29ac",
      "name": "DATA FORMATTER"
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "whatsapp_user_profiles",
        "limit": 1,
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "keyName": "=company_id",
              "condition": "eq",
              "keyValue": "={{ $json.company_id }}"
            },
            {
              "keyName": "=phone_number",
              "condition": "eq",
              "keyValue": "={{ $json.phone_number }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        1472,
        -512
      ],
      "id": "88a42a9f-d3d7-4611-be10-8ee128fa8769",
      "name": "CHECK USER",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "SYQY7Y5p1hnytb5L",
          "name": "Supabase account 2"
        }
      },
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key={{ $json.gemini_api_key }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{\n  {\n    \"contents\": [{\n      \"role\": \"user\",\n      \"parts\": [{\n        \"text\": $json.gemini_prompt\n      }]\n    }],\n    \"generationConfig\": {\n      \"temperature\": 0.7,\n      \"maxOutputTokens\": 2048,\n      \"topP\": 0.95,\n      \"topK\": 40,\n      \"responseMimeType\": \"application/json\"\n    }\n  }\n}}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        7152,
        -544
      ],
      "id": "ec00c3ad-ca88-4f34-a591-e38efd474cdb",
      "name": "Gemini API (Dynamic)",
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('Context Builder').item.json.evolution_api_url }}message/sendText/{{ $('Context Builder').item.json.instance_name }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{ $('Context Builder').item.json.evolution_api_key }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "number",
              "value": "={{ $('Format Response').item.json.phone_number }}"
            },
            {
              "name": "text",
              "value": "={{ $('Format Response').item.json.ai_response }}"
            },
            {
              "name": "delay",
              "value": "={{ 1000 }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        9040,
        368
      ],
      "id": "7bf054d8-2ee9-4971-a8a0-245cf457dd20",
      "name": "HTTP Request"
    },
    {
      "parameters": {
        "jsCode": "const geminiResponse = $input.first().json;\n\ntry {\n  // Gemini'nin cevabÄ±nÄ± parse et\n  const responseText = geminiResponse.candidates[0].content.parts[0].text;\n  \n  // JSON'a Ã§evir\n  let aiResponse;\n  try {\n    aiResponse = JSON.parse(responseText);\n  } catch (e) {\n    // EÄŸer JSON deÄŸilse, fallback\n    aiResponse = {\n      detected_language: 'tr',\n      detected_intent: 'general_chat',\n      confidence: 0.5,\n      action: 'general_response',\n      next_state: 'idle',\n      response: responseText,\n      needs_sheets_query: false,\n      needs_calendar_check: false,\n      ready_to_execute: false,\n      collected_data: {},\n      metadata: {}\n    };\n  }\n  \n  // Ã–nceki verileri koru (Context Builder'dan gelen)\n  const previousData = $('Context Builder').first().json;\n  \n  // ============================================================\n  // YENÄ° VERÄ° YAPISI\n  // ============================================================\n  \n  return {\n    json: {\n      ...previousData,\n      \n      // AI Response (tam)\n      ai_response: aiResponse,\n      \n      // Intent Detection\n      detected_intent: aiResponse.detected_intent,\n      detected_language: aiResponse.detected_language,\n      intent_confidence: aiResponse.confidence,\n      action: aiResponse.action,\n      \n      // Response\n      bot_response: aiResponse.response || '', // BoÅŸ olabilir!\n      \n      // Metadata\n      intent_metadata: aiResponse.metadata || {},\n      \n      // ============================================================\n      // YENÄ°: CONVERSATION STATE MANAGEMENT\n      // ============================================================\n      \n      next_state: aiResponse.next_state || 'idle',\n      needs_sheets_query: aiResponse.needs_sheets_query || false,\n      needs_calendar_check: aiResponse.needs_calendar_check || false,\n      ready_to_execute: aiResponse.ready_to_execute || false,\n      \n      // Collected data (merge with existing)\n      collected_data: {\n        ...previousData.collected_data,\n        ...aiResponse.collected_data\n      },\n      \n      // ============================================================\n      // GEMINI RAW RESPONSE (DEBUG)\n      // ============================================================\n      gemini_raw_response: geminiResponse\n    }\n  };\n  \n} catch (error) {\n  // Error handling\n  const previousData = $('Context Builder').first().json;\n  \n  return {\n    json: {\n      ...previousData,\n      error: true,\n      error_message: error.message,\n      error_type: 'gemini_parse_error',\n      detected_intent: 'general_chat',\n      next_state: 'idle',\n      bot_response: 'ÃœzgÃ¼nÃ¼m, bir hata oluÅŸtu. LÃ¼tfen tekrar deneyin.'\n    }\n  };\n}"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        7584,
        -560
      ],
      "id": "8004210b-e339-47bf-83df-17eb5ca6045c",
      "name": "Parse Gemini Response"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://rlrnurzpeanloppntldg.supabase.co/rest/v1/rpc/get_primary_sheet_for_intent",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJscm51cnpwZWFubG9wcG50bGRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAyMDY5NTYsImV4cCI6MjA3NTc4Mjk1Nn0.d50ICp_1Rgg57c3kUCeZfTM86qZegaWXv56mQLAX6UQ"
            },
            {
              "name": "Authorization",
              "value": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJscm51cnpwZWFubG9wcG50bGRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAyMDY5NTYsImV4cCI6MjA3NTc4Mjk1Nn0.d50ICp_1Rgg57c3kUCeZfTM86qZegaWXv56mQLAX6UQ"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "p_company_id",
              "value": "={{ $('Parse Gemini Response').item.json.company_id }}"
            },
            {
              "name": "p_intent",
              "value": "price_query"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        8480,
        -1360
      ],
      "id": "7723f9cb-1fc4-400f-8366-24a3ca472c14",
      "name": "Get Primary Sheet"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "a90dd80a-3e2c-4e2e-b736-2a3ae87fa47e",
              "leftValue": "={{ $json[0].sheet_id }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        8832,
        -1360
      ],
      "id": "78b0bf7d-241f-491b-b5e0-0c5f07361e3a",
      "name": "Check Sheet Exists"
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "documentId": {
          "__rl": true,
          "value": "={{ $('Get Primary Sheet').first().json[0].google_sheet_id }}",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": "=={{ $('Get Primary Sheet').first().json[0].worksheet_name }}",
          "mode": "name"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        9168,
        -1536
      ],
      "id": "429992e6-0c22-46c0-b3cb-63644d275032",
      "name": "Get Sheet Data",
      "credentials": {
        "googleApi": {
          "id": "d9uNsv6UUdhTsb6Z",
          "name": "Google Service Account account"
        }
      },
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "jsCode": "// Aranacak query (AI'dan gelen)\nconst searchQuery = $('Parse Gemini Response').first().json.intent_metadata?.query || '';\nconst sheetData = $('Get Sheet Data').first().json; // TÃ¼m sheet verisi\nconst previousData = $('Parse Gemini Response').first().json;\n\n// Sheet verisi array olarak gelir\nconst rows = Array.isArray(sheetData) ? sheetData : [sheetData];\n\n// Basit arama (case-insensitive)\nconst searchLower = searchQuery.toLowerCase();\n\n// TÃ¼m satÄ±rlarda ara\nconst results = rows.filter(row => {\n  // Her kolonun deÄŸerini kontrol et\n  return Object.values(row).some(value => {\n    if (value && typeof value === 'string') {\n      return value.toLowerCase().includes(searchLower);\n    }\n    return false;\n  });\n}).slice(0, 5); // Ä°lk 5 sonucu al\n\n// SonuÃ§larÄ± formatla\nlet responseText = '';\nif (results.length > 0) {\n  responseText = `ðŸ” *${searchQuery}* iÃ§in ${results.length} sonuÃ§ bulundu:\\n\\n`;\n  \n  results.forEach((item, index) => {\n    responseText += `${index + 1}. `;\n    \n    // TÃ¼m kolonlarÄ± gÃ¶ster (null/undefined olanlarÄ± atla)\n    Object.entries(item).forEach(([key, value]) => {\n      if (value && key !== 'id') {\n        responseText += `*${key}:* ${value}\\n`;\n      }\n    });\n    \n    responseText += '\\n';\n  });\n} else {\n  responseText = `ÃœzgÃ¼nÃ¼m, *${searchQuery}* iÃ§in sonuÃ§ bulunamadÄ±. FarklÄ± bir arama terimi dener misiniz?`;\n}\n\nreturn {\n  json: {\n    ...previousData,\n    sheets_results: results,\n    sheets_results_count: results.length,\n    search_query: searchQuery,\n    bot_response: responseText\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        9408,
        -1664
      ],
      "id": "9ca9ab84-3fba-40b1-8fe4-57660bdafca4",
      "name": "Search in Sheets"
    },
    {
      "parameters": {
        "tableId": "sheets_query_log",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "company_id",
              "fieldValue": "={{ $json.company_id }}"
            },
            {
              "fieldId": "sheets_instance_id",
              "fieldValue": "={{ $('Get Primary Sheet').first().json[0].sheet_id }}"
            },
            {
              "fieldId": "customer_phone",
              "fieldValue": "={{ $json.phone_number }}"
            },
            {
              "fieldId": "customer_name",
              "fieldValue": "={{ $json.sender_name }}"
            },
            {
              "fieldId": "query_text",
              "fieldValue": "={{ $json.search_query }}"
            },
            {
              "fieldId": "query_intent",
              "fieldValue": "price_query"
            },
            {
              "fieldId": "query_language",
              "fieldValue": "={{ $json.detected_language }}"
            },
            {
              "fieldId": "results_count",
              "fieldValue": "={{ $json.sheets_results_count }}"
            },
            {
              "fieldId": "bot_response",
              "fieldValue": "={{ $json.bot_response }}"
            },
            {
              "fieldId": "status",
              "fieldValue": "completed"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        9632,
        -1664
      ],
      "id": "2eff4ee7-1851-4639-9c53-4436a1649548",
      "name": "Log Sheets Query",
      "credentials": {
        "supabaseApi": {
          "id": "SYQY7Y5p1hnytb5L",
          "name": "Supabase account 2"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "3496b8ba-dc66-4013-97ea-69be22e08c11",
              "name": "ai_response",
              "value": "={{ $json.bot_response }}",
              "type": "string"
            },
            {
              "id": "d6335c8e-1a33-4ea4-b2f6-db695ce0f170",
              "name": "user_message_id",
              "value": "={{ $now.toString() + '_user' }}",
              "type": "string"
            },
            {
              "id": "563f9ad1-3340-4acc-bca8-8c1303980c7e",
              "name": "bot_message_id",
              "value": "={{ $now.toString() + '_bot' }}",
              "type": "string"
            },
            {
              "id": "12465fea-3f17-4a80-bcc6-14bd00452a5e",
              "name": "session_id",
              "value": "={{ $('Context Builder').item.json.session_id }}",
              "type": "string"
            },
            {
              "id": "0ea4fe37-37b8-4c84-b6ef-4a635d4fc152",
              "name": "user_id",
              "value": "={{ $('Context Builder').item.json.user_id }}",
              "type": "string"
            },
            {
              "id": "5501e043-a657-4b8f-9b70-10640aa8720f",
              "name": "instance_id",
              "value": "={{ $('Context Builder').item.json.instance_id }}",
              "type": "string"
            },
            {
              "id": "b438e2fe-088e-4bd1-a18a-b8d46ff46187",
              "name": "phone_number",
              "value": "={{ $('Context Builder').item.json.phone_number }}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        9920,
        -1664
      ],
      "id": "f924a89c-4328-4640-9fd4-38b8f34c71c6",
      "name": "Format Response2"
    },
    {
      "parameters": {
        "tableId": "whatsapp_messages",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "sender",
              "fieldValue": "=bot"
            },
            {
              "fieldId": "sender_name",
              "fieldValue": "agent"
            },
            {
              "fieldId": "message_body",
              "fieldValue": "={{ $json.ai_response }}"
            },
            {
              "fieldId": "message_owner",
              "fieldValue": "bot"
            },
            {
              "fieldId": "message_type",
              "fieldValue": "text"
            },
            {
              "fieldId": "instance_id",
              "fieldValue": "={{ $json.instance_id }}"
            },
            {
              "fieldId": "created_at",
              "fieldValue": "={{ new Date().toISOString() }}"
            },
            {
              "fieldId": "user_id",
              "fieldValue": "={{ $json.user_id.toString() }}"
            },
            {
              "fieldId": "session_id",
              "fieldValue": "={{ $json.session_id.toString() }}"
            },
            {
              "fieldId": "company_id",
              "fieldValue": "={{ $('Inject IDs').item.json.company_id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        10224,
        -1664
      ],
      "id": "2ef8ffb6-e866-4b30-9ad1-f65ba3e3fee6",
      "name": "Save Bot Response2",
      "credentials": {
        "supabaseApi": {
          "id": "SYQY7Y5p1hnytb5L",
          "name": "Supabase account 2"
        }
      },
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "user_profiles",
        "filters": {
          "conditions": [
            {
              "keyName": "phone_number",
              "condition": "eq",
              "keyValue": "={{ $('Context Builder').item.json.phone_number }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "last_seen",
              "fieldValue": "={{ new Date().toISOString() }}"
            },
            {
              "fieldId": "total_messages",
              "fieldValue": "={{ parseInt($json.total_messages || 0) + 1 }}"
            },
            {
              "fieldId": "customer_status",
              "fieldValue": "={{ parseInt($json.total_messages || 0) >= 4 ? \"old\" : \"new\" }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        11104,
        -1680
      ],
      "id": "2658ce3a-4da9-4236-be6d-ffa30581dbee",
      "name": "Update User Stats2",
      "credentials": {
        "supabaseApi": {
          "id": "YWr0zYtmMCKrbiNV",
          "name": "Supabase account"
        }
      },
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        11648,
        -1712
      ],
      "id": "79813ef0-dac1-4ed2-85cd-bd28d9530a67",
      "name": "Respond to Webhook2"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('Context Builder').item.json.evolution_api_url }}message/sendText/{{ $('Context Builder').item.json.instance_name }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{ $('Context Builder').item.json.evolution_api_key }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "number",
              "value": "={{ $('Format Response2').item.json.phone_number }}"
            },
            {
              "name": "text",
              "value": "={{ $('Format Response2').item.json.ai_response }}"
            },
            {
              "name": "delay",
              "value": "={{ 1000 }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        10480,
        -1680
      ],
      "id": "56e5f8fd-7138-48e8-bcd4-09bd8bca941a",
      "name": "HTTP Request1"
    },
    {
      "parameters": {
        "jsCode": "// OlasÄ± yedek mesajlar (Ã‡eÅŸitlilik artÄ±rÄ±ldÄ±)\nconst fallbackMessages = [\n    \"Åžu an teknik bir yoÄŸunluk nedeniyle yanÄ±tlar biraz gecikebilir. MesajÄ±nÄ±z bize ulaÅŸtÄ±, size en kÄ±sa sÃ¼rede Ã¶zel bir yanÄ±tla dÃ¶neceÄŸim. AnlayÄ±ÅŸÄ±nÄ±z iÃ§in teÅŸekkÃ¼rler! ðŸ™\",\n    \"Sistemlerimizde anlÄ±k bir kesinti meydana geldi. Bu durum sadece birkaÃ§ dakikalÄ±k, hemen Ã§Ã¶zÃ¼yoruz! LÃ¼tfen biraz bekleyin, size detaylÄ± cevapla geri dÃ¶neceÄŸim. ðŸ› ï¸\",\n    \"Allync AI ÅŸu an kapasitesinin Ã¼stÃ¼nde Ã§alÄ±ÅŸÄ±yor! ðŸ˜… MesajÄ±nÄ±z iÅŸleniyor, lÃ¼tfen birkaÃ§ dakika iÃ§inde tekrar deneyin. YoÄŸunluktan dolayÄ± Ã¶zÃ¼r dileriz.\",\n    \"Beklenmedik bir sunucu hatasÄ±yla karÅŸÄ±laÅŸtÄ±k. Sorun tamamen bizden kaynaklanÄ±yor. LÃ¼tfen mesajÄ±nÄ±zÄ± tekrarlayÄ±n veya 5 dakika sonra tekrar yazÄ±n. SabrÄ±nÄ±z iÃ§in teÅŸekkÃ¼r ederiz. ðŸ˜”\",\n    \"MesajÄ±nÄ±z baÅŸarÄ±yla kaydedildi ancak yapay zeka beynimiz ÅŸu an gÃ¼ncelleniyor. ðŸ˜‰ Bu kÄ±sa aradan sonra, sorunuza hemen geri dÃ¶neceÄŸiz!\",\n    \"Ah, teknik bir aksaklÄ±k oldu! KonuÅŸmaya kaldÄ±ÄŸÄ±nÄ±z yerden devam edebiliriz ama lÃ¼tfen mesajÄ±nÄ±zÄ± tekrar gÃ¶nderin. Hemen Ã§Ã¶zÃ¼me odaklanÄ±yorum. âœ¨\",\n    \"Ä°letiÅŸimde kÄ±sa bir kopukluk yaÅŸadÄ±k. LÃ¼tfen mesajÄ±nÄ±zÄ±n ana hatlarÄ±nÄ± tekrar yazÄ±n, bu sefer kaÃ§Ä±rmayacaÄŸÄ±m! Tekrar denediÄŸiniz iÃ§in teÅŸekkÃ¼rler.\",\n    \"Bazen en iyi yapay zekalar bile mola vermek zorunda kalÄ±r! â˜•ï¸ Size birkaÃ§ saniye iÃ§inde Ã§ok daha net ve faydalÄ± bir yanÄ±t verebilmek iÃ§in Ã§alÄ±ÅŸÄ±yorum. BeklettiÄŸim iÃ§in kusura bakmayÄ±n.\",\n    \"GÃ¼venlik duvarlarÄ±mÄ±zda geÃ§ici bir kontrol var. Bu, yanÄ±tÄ±mÄ±n size ulaÅŸmasÄ±nÄ± kÄ±sa sÃ¼reliÄŸine engelliyor. LÃ¼tfen en geÃ§ 1-2 dakika iÃ§inde size dÃ¶neceÄŸimizi bilin.\",\n    \"Sistemsel bir hata nedeniyle isteÄŸinizi ÅŸu an tamamlayamÄ±yoruz. Sorunu gidermek iÃ§in acil mÃ¼dahale ekibimiz Ã§alÄ±ÅŸÄ±yor. LÃ¼tfen kÄ±sa bir sÃ¼re sonra tekrar deneyiniz. ðŸš€\"\n  \"Ä°steÄŸiniz yÃ¼ksek Ã¶ncelikli olarak iÅŸaretlendi, ancak sistemlerimizde anlÄ±k bir yÃ¼klenme sÃ¶z konusu. Bu nedenle yanÄ±t biraz gecikiyor. LÃ¼tfen sabrÄ±nÄ±zÄ± rica ediyoruz. ðŸ™\",\n    \"GeliÅŸmiÅŸ AI motorumuz, isteÄŸinizi daha derinlemesine analiz ediyor ve bu durum kÄ±sa bir gecikmeye neden oldu. Size mÃ¼mkÃ¼n olan en doÄŸru ve kapsamlÄ± yanÄ±tÄ± getirmek Ã¼zereyiz!\",\n    \"Allync AI olarak, size kesintisiz hizmet vermeyi hedefliyoruz ancak ÅŸu an kritik bir optimizasyon sÃ¼recindeyiz. En yakÄ±n zamanda size geri dÃ¶nÃ¼ÅŸ yapacaÄŸÄ±z. KÄ±sa bekleyiÅŸiniz iÃ§in teÅŸekkÃ¼rler. ðŸ› ï¸\",\n    \"Ä°letiÅŸim kanallarÄ±mÄ±zda beklenmedik bir tÄ±kanÄ±klÄ±k oluÅŸtu. Teknik ekibimiz bu durumu anÄ±nda Ã§Ã¶zmek iÃ§in Ã§alÄ±ÅŸÄ±yor. LÃ¼tfen kÄ±sa bir sÃ¼re sonra tekrar yazÄ±nÄ±z. Size hÄ±zla ulaÅŸacaÄŸÄ±z. ðŸš€\",\n    \"MesajÄ±nÄ±zÄ± aldÄ±k! Ne yazÄ±k ki, anlÄ±k teknik aksaklÄ±k nedeniyle yanÄ±tÄ± hemen oluÅŸturamÄ±yoruz. KonuÅŸma kaydÄ±nÄ±z gÃ¼vende, lÃ¼tfen yakÄ±nda tekrar kontrol edin.\",\n    \"Bize ulaÅŸtÄ±ÄŸÄ±nÄ±z iÃ§in teÅŸekkÃ¼rler. Åžu anda bir dizi taleple ilgileniyoruz, bu yÃ¼zden yanÄ±t sÃ¼remiz normalin biraz Ã¼zerinde. AnlayÄ±ÅŸÄ±nÄ±z iÃ§in minnettarÄ±z. ðŸ¤—\",\n    \"OlasÄ± bir hizmet kesintisini Ã¶nlemek amacÄ±yla sistemlerimizi kontrol ediyoruz. Bu geÃ§ici bir durumdur. MesajÄ±nÄ±z bize ulaÅŸtÄ±, lÃ¼tfen beklemede kalÄ±n.\",\n    \"Size Ã¶zel bir yanÄ±t hazÄ±rlamak Ã¼zereydim ki bir sunucu hatasÄ± yaÅŸadÄ±k. BaÅŸÄ±nÄ±zdan geÃ§en bu aksaklÄ±k iÃ§in Ã¶zÃ¼r dileriz. LÃ¼tfen mesajÄ±nÄ±zÄ± tekrar gÃ¶nderin, bu sefer kesin yanÄ±t alacaksÄ±nÄ±z!\",\n    \"Talebiniz Ã§ok detaylÄ±! AI beynimiz bu veriyi iÅŸlerken kÄ±sa bir takÄ±lma yaÅŸadÄ±. ðŸ˜Š Bu esnada bir nefes alÄ±n, biz sorununuzu Ã§Ã¶zmek iÃ§in yeniden baÅŸlatÄ±yoruz.\",\n    \"Dikkat! ðŸš¦ Åžu an tÃ¼m AI kaynaklarÄ±mÄ±z sÄ±nÄ±rda Ã§alÄ±ÅŸÄ±yor. MesajÄ±nÄ±zÄ± sisteme aldÄ±k ve sÄ±raya koyduk. Birazdan Ã¶nceliÄŸinizle ilgilenmeye baÅŸlayacaÄŸÄ±z.\"\n\n];\n\n// Rastgele bir mesaj seÃ§me\nconst randomIndex = Math.floor(Math.random() * fallbackMessages.length);\nconst aiResponse = fallbackMessages[randomIndex];\n\n// Veriyi Gemini'den gelmiÅŸ gibi formatla (Format Response dÃ¼ÄŸmesine uymasÄ± iÃ§in)\n// Mevcut verileri koruyun ve sadece ai_response alanÄ±nÄ± ekleyin\nreturn [{\n    json: {\n        ...$input.item.json,\n        // Format Response dÃ¼ÄŸÃ¼mÃ¼nÃ¼n $json.content.parts[0].text ifadesini okuyabilmesi iÃ§in gerekli yapÄ±\n        content: { \n            parts: [{\n                text: aiResponse\n            }]\n        }\n    }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        9168,
        -1184
      ],
      "id": "e1528a69-7abc-4301-bb44-8b8f904876ac",
      "name": "Code in JavaScript1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "3496b8ba-dc66-4013-97ea-69be22e08c11",
              "name": "ai_response",
              "value": "={{ $json.content?.parts?.[0]?.text || $json.candidates?.[0]?.content?.parts?.[0]?.text }}",
              "type": "string"
            },
            {
              "id": "d6335c8e-1a33-4ea4-b2f6-db695ce0f170",
              "name": "user_message_id",
              "value": "={{ $now.toString() + '_user' }}",
              "type": "string"
            },
            {
              "id": "563f9ad1-3340-4acc-bca8-8c1303980c7e",
              "name": "bot_message_id",
              "value": "={{ $now.toString() + '_bot' }}",
              "type": "string"
            },
            {
              "id": "12465fea-3f17-4a80-bcc6-14bd00452a5e",
              "name": "session_id",
              "value": "={{ $('Context Builder').item.json.session_id }}",
              "type": "string"
            },
            {
              "id": "0ea4fe37-37b8-4c84-b6ef-4a635d4fc152",
              "name": "user_id",
              "value": "={{ $('Context Builder').item.json.user_id }}",
              "type": "string"
            },
            {
              "id": "5501e043-a657-4b8f-9b70-10640aa8720f",
              "name": "instance_id",
              "value": "={{ $('Context Builder').item.json.instance_id }}",
              "type": "string"
            },
            {
              "id": "98282356-8207-4494-a5b1-4e1f531ca9fd",
              "name": "sender",
              "value": "={{ $('Normalize Session ID').item.json.sender }}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        9376,
        -1184
      ],
      "id": "343e6e23-904e-4742-98db-2f8273e73b1c",
      "name": "Format Response3"
    },
    {
      "parameters": {
        "resource": "messages-api",
        "instanceName": "Allync-Whatsappweb",
        "remoteJid": "={{ $json.sender }}",
        "messageText": "={{ $('Format Response3').item.json.ai_response }}",
        "options_message": {
          "delay": 1000
        }
      },
      "type": "n8n-nodes-evolution-api-en.evolutionApi",
      "typeVersion": 1,
      "position": [
        9808,
        -1184
      ],
      "id": "e8e8973f-d63b-4f73-b60f-f62629b7469c",
      "name": "Evolution API - Send Text",
      "credentials": {
        "evolutionApi": {
          "id": "wFhBeMvsjPDX1CnA",
          "name": "Allync-Qatar"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "user_profiles",
        "filters": {
          "conditions": [
            {
              "keyName": "phone_number",
              "condition": "eq",
              "keyValue": "={{ $('Context Builder').item.json.phone_number }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "last_seen",
              "fieldValue": "={{ new Date().toISOString() }}"
            },
            {
              "fieldId": "total_messages",
              "fieldValue": "={{ parseInt($json.total_messages || 0) + 1 }}"
            },
            {
              "fieldId": "customer_status",
              "fieldValue": "={{ parseInt($json.total_messages || 0) >= 4 ? \"old\" : \"new\" }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        10000,
        -1184
      ],
      "id": "d32b9a43-83dd-4222-b6d5-e2f0c7beca5e",
      "name": "Update User Stats3",
      "credentials": {
        "supabaseApi": {
          "id": "YWr0zYtmMCKrbiNV",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "whatsapp_sessions",
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "keyName": "id",
              "condition": "eq",
              "keyValue": "={{ $('Context Builder').item.json.session_id }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "conversation_state",
              "fieldValue": "idle"
            },
            {
              "fieldId": "collected_data",
              "fieldValue": "={{ JSON.stringify({}) }}"
            },
            {
              "fieldId": "last_intent",
              "fieldValue": "error"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        10208,
        -1184
      ],
      "id": "d143ae63-f834-4de4-a879-283ede34e831",
      "name": "Update Session3",
      "alwaysOutputData": false,
      "credentials": {
        "supabaseApi": {
          "id": "SYQY7Y5p1hnytb5L",
          "name": "Supabase account 2"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        10416,
        -1184
      ],
      "id": "1577e88e-5ba8-49f9-8096-3091563697f2",
      "name": "Respond to Webhook3"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://rlrnurzpeanloppntldg.supabase.co/rest/v1/rpc/check_privileged_user",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJscm51cnpwZWFubG9wcG50bGRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAyMDY5NTYsImV4cCI6MjA3NTc4Mjk1Nn0.d50ICp_1Rgg57c3kUCeZfTM86qZegaWXv56mQLAX6UQ"
            },
            {
              "name": "Authorization",
              "value": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJscm51cnpwZWFubG9wcG50bGRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAyMDY5NTYsImV4cCI6MjA3NTc4Mjk1Nn0.d50ICp_1Rgg57c3kUCeZfTM86qZegaWXv56mQLAX6UQ"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "=={{\n  {\n    \"p_company_id\": $json.company_id,\n    \"p_phone_number\": $json.phone_number\n  }\n}}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1824,
        -528
      ],
      "id": "a806abeb-0ad4-45b6-8a57-d5b5c3639caf",
      "name": "Check Privileged User",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.needs_sheets_query }}",
                    "rightValue": "",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    },
                    "id": "959a01a0-536e-4d6e-9374-47ae537bcf5b"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Sheets Query"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "9e68b5e3-1e86-4922-8bb7-dda5c20cc25a",
                    "leftValue": "={{ $json.needs_calendar_check }}",
                    "rightValue": "",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Calendar Check"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "bd380948-717d-4cbc-acb9-3b1808f51a97",
                    "leftValue": "={{ $json.bot_response }}",
                    "rightValue": "",
                    "operator": {
                      "type": "string",
                      "operation": "notEmpty",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Direct Response"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        8144,
        -592
      ],
      "id": "b3a3b25b-e44c-4879-8b20-c0d93e809cfb",
      "name": "ACTION ROUTER"
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "whatsapp_sessions",
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "keyName": "id",
              "condition": "eq",
              "keyValue": "=={{ $('Context Builder').item.json.session_id }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "conversation_state",
              "fieldValue": "={{ $('Parse Gemini Response').item.json.next_state }}"
            },
            {
              "fieldId": "collected_data",
              "fieldValue": "={{ JSON.stringify($('Parse Gemini Response').item.json.collected_data) }}"
            },
            {
              "fieldId": "last_intent",
              "fieldValue": "={{ $('Parse Gemini Response').item.json.detected_intent }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        11376,
        -1696
      ],
      "id": "a27411cb-5ef3-49d4-b1b6-29f20fcfa452",
      "name": "Update Session2",
      "alwaysOutputData": false,
      "credentials": {
        "supabaseApi": {
          "id": "SYQY7Y5p1hnytb5L",
          "name": "Supabase account 2"
        }
      },
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "tableId": "whatsapp_messages",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "sender",
              "fieldValue": "=bot"
            },
            {
              "fieldId": "sender_name",
              "fieldValue": "agent"
            },
            {
              "fieldId": "message_body",
              "fieldValue": "={{ $json.ai_response }}"
            },
            {
              "fieldId": "message_owner",
              "fieldValue": "bot"
            },
            {
              "fieldId": "message_type",
              "fieldValue": "text"
            },
            {
              "fieldId": "instance_id",
              "fieldValue": "={{ $json.instance_id }}"
            },
            {
              "fieldId": "created_at",
              "fieldValue": "={{ new Date().toISOString() }}"
            },
            {
              "fieldId": "user_id",
              "fieldValue": "={{ $json.user_id.toString() }}"
            },
            {
              "fieldId": "session_id",
              "fieldValue": "={{ $json.session_id.toString() }}"
            },
            {
              "fieldId": "company_id",
              "fieldValue": "={{ $('Inject IDs').item.json.company_id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        9584,
        -1184
      ],
      "id": "4a8f4207-1271-4cfd-8770-52b628b7e657",
      "name": "Save Bot Response3",
      "credentials": {
        "supabaseApi": {
          "id": "SYQY7Y5p1hnytb5L",
          "name": "Supabase account 2"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// ============================================================\n// BUILD GEMINI PROMPT - PROFESYONEL VERSÄ°YON + ENTEGRASYON KONTROLÃœ\n// ============================================================\n\nconst data = $input.first().json;\n\n// ============================================================\n// ENTEGRASYON DURUM KONTROLÃœ\n// ============================================================\n\nconst sheetsEnabled = data.sheets_enabled || false;\nconst calendarEnabled = data.calendar_enabled || false;\n\n// ============================================================\n// VIP USER KONTROLÃœ\n// ============================================================\n\nlet userTypeSection = '';\n\nif (data.is_privileged_user) {\n  const vipFeatures = data.privileged_allowed_features || {};\n  \n  userTypeSection = `\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nðŸ” YETKÄ°LÄ° KULLANICI\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nSeviye: ${data.privilege_level || 'owner'}\nHitap: ${data.greeting_name || 'SayÄ±n Yetkili'}\n\nÄ°ZÄ°N VERÄ°LEN Ã–ZEL BÄ°LGÄ°LER:\n${vipFeatures.view_stock ? 'âœ…' : 'âŒ'} Stok bilgisi gÃ¶rebilir\n${vipFeatures.view_all_appointments ? 'âœ…' : 'âŒ'} TÃ¼m randevularÄ± gÃ¶rebilir\n${vipFeatures.view_reports ? 'âœ…' : 'âŒ'} Raporlara eriÅŸebilir\n${vipFeatures.access_customer_data ? 'âœ…' : 'âŒ'} MÃ¼ÅŸteri verilerine eriÅŸebilir\n\nâš ï¸ KRÄ°TÄ°K: Bu kullanÄ±cÄ±ya DETAYLI bilgi ver!\nÃ–rnek: \"Evet ${data.greeting_name || 'SayÄ±n Yetkili'}, iPhone 15'ten 10 adet stokumuz var.\"\n`;\n} else {\n  userTypeSection = `\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nðŸ‘¤ NORMAL MÃœÅžTERÄ°\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nâš ï¸ KISITLAMALAR:\nâŒ Stok adedi paylaÅŸÄ±lmaz\nâŒ TÃ¼m randevu listesi gÃ¶sterilmez\nâŒ Hassas bilgiler gizlenir\n\nÃ–rnek: \"Stok bilgisi iÃ§in lÃ¼tfen maÄŸazamÄ±zla iletiÅŸime geÃ§ebilirsiniz.\"\n`;\n}\n\n// ============================================================\n// ALLOWED FEATURES (ENTEGRASYON DURUMU DAHÄ°L)\n// ============================================================\n\nconst features = data.allowed_features || {};\n\nconst featuresSection = `\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nÄ°ZÄ°N VERÄ°LEN Ã–ZELLÄ°KLER VE ENTEGRASYON DURUMU\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n${features.general_chat ? 'âœ…' : 'âŒ'} Genel Sohbet\n${features.price_query && sheetsEnabled ? 'âœ…' : features.price_query ? 'âš ï¸' : 'âŒ'} Fiyat Sorgusu ${!sheetsEnabled && features.price_query ? '(Google Sheets baÄŸlÄ± deÄŸil - manuel yÃ¶nlendir!)' : sheetsEnabled ? '(Google Sheets aktif)' : ''}\n${features.appointment && calendarEnabled ? 'âœ…' : features.appointment ? 'âš ï¸' : 'âŒ'} Randevu Alma ${!calendarEnabled && features.appointment ? '(Google Calendar baÄŸlÄ± deÄŸil - manuel yÃ¶nlendir!)' : calendarEnabled ? '(Google Calendar aktif)' : ''}\n${features.product_info && sheetsEnabled ? 'âœ…' : features.product_info ? 'âš ï¸' : 'âŒ'} ÃœrÃ¼n Bilgisi ${!sheetsEnabled && features.product_info ? '(Google Sheets baÄŸlÄ± deÄŸil - manuel yÃ¶nlendir!)' : sheetsEnabled ? '(Google Sheets aktif)' : ''}\n${features.stock_check && sheetsEnabled ? 'âœ…' : features.stock_check ? 'âš ï¸' : 'âŒ'} Stok KontrolÃ¼ ${!sheetsEnabled && features.stock_check ? '(Google Sheets baÄŸlÄ± deÄŸil - manuel yÃ¶nlendir!)' : ''}\n${features.complaint_handling ? 'âœ…' : 'âŒ'} Åžikayet YÃ¶netimi\n\nâš ï¸ KRÄ°TÄ°K ENTEGRASYON KURALLARI:\n${!sheetsEnabled ? 'ðŸ”´ GOOGLE SHEETS BAÄžLI DEÄžÄ°L! Fiyat/Stok/ÃœrÃ¼n sorularÄ±nda:\\n   â†’ Kibarca reddet: \"Bu Ã¶zellik ÅŸu an aktif deÄŸil, lÃ¼tfen bizimle direkt iletiÅŸime geÃ§in\"\\n   â†’ needs_sheets_query: FALSE yap\\n   â†’ response alanÄ±nÄ± DOLDUR' : ''}\n${!calendarEnabled ? 'ðŸ”´ GOOGLE CALENDAR BAÄžLI DEÄžÄ°L! Randevu taleplerinde:\\n   â†’ Kibarca reddet: \"Randevu sistemi ÅŸu an aktif deÄŸil, lÃ¼tfen bizimle direkt iletiÅŸime geÃ§in\"\\n   â†’ needs_calendar_check: FALSE yap\\n   â†’ response alanÄ±nÄ± DOLDUR' : ''}\n\n${data.stay_on_topic ? 'âš ï¸ SADECE Ä°ÅžLE Ä°LGÄ°LÄ° KONULARA CEVAP VER!' : ''}\n`;\n\n// ============================================================\n// DÄ°L AYARLARI\n// ============================================================\n\nconst languages = data.supported_languages || ['tr', 'en'];\n\nconst languageSection = `\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nDÄ°L AYARLARI\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nDesteklenen: ${languages.join(', ')}\nVarsayÄ±lan: ${data.default_language || 'tr'}\n\nâš ï¸ KullanÄ±cÄ±nÄ±n dilini tespit et ve AYNI DÄ°LDE cevap ver!\n`;\n\n// ============================================================\n// CONVERSATION STATE\n// ============================================================\n\nconst stateSection = `\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nCONVERSATION STATE (MULTI-TURN)\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nÅžu Anki Durum: ${data.conversation_state || 'idle'}\nSon Intent: ${data.last_intent || 'yok'}\nToplanan Veriler: ${JSON.stringify(data.collected_data || {})}\n\nSTATE AÃ‡IKLAMALARI:\nðŸ“Œ \"idle\" â†’ Normal konuÅŸma, intent tespit et\nðŸ“Œ \"awaiting_product_name\" â†’ KullanÄ±cÄ± Ã¼rÃ¼n ismi veriyor\nðŸ“Œ \"awaiting_appointment_date\" â†’ KullanÄ±cÄ± tarih veriyor\nðŸ“Œ \"awaiting_appointment_time\" â†’ KullanÄ±cÄ± saat veriyor\nðŸ“Œ \"awaiting_confirmation\" â†’ Onay bekleniyor\nðŸ“Œ \"collecting_appointment_details\" â†’ Ä°sim/sebep toplanÄ±yor\n`;\n\n// ============================================================\n// INTENT TÄ°PLERÄ° (ENTEGRASYON DURUMUNA GÃ–RE)\n// ============================================================\n\nconst intentSection = `\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nINTENT TÄ°PLERÄ° VE DAVRANIÅžLAR\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nðŸ“Œ \"general_chat\": Normal sohbet, selamlaÅŸma, teÅŸekkÃ¼r\n   â†’ SEN DOÄžRUDAN CEVAP VER\n   â†’ next_state: \"idle\"\n   â†’ needs_sheets_query: false\n   â†’ needs_calendar_check: false\n\nðŸ“Œ \"price_query\": Fiyat sorgusu\n   \n   ${!sheetsEnabled ? \n   `ðŸ”´ GOOGLE SHEETS YOK!\n   â†’ response: \"Fiyat bilgisi iÃ§in lÃ¼tfen bizimle direkt iletiÅŸime geÃ§ebilirsiniz.\"\n   â†’ needs_sheets_query: FALSE\n   â†’ next_state: \"idle\"` \n   : \n   `âœ… GOOGLE SHEETS AKTÄ°F\n   \n   EÄžER state=\"idle\" ve Ã¼rÃ¼n adÄ± YOK:\n   â†’ response: \"Tabii, hangi Ã¼rÃ¼n hakkÄ±nda bilgi almak istersiniz?\"\n   â†’ next_state: \"awaiting_product_name\"\n   â†’ needs_sheets_query: FALSE\n   \n   EÄžER state=\"awaiting_product_name\" VEYA Ã¼rÃ¼n adÄ± BELLÄ°:\n   â†’ response: \"\" (BOÅž!)\n   â†’ metadata.query: \"Ã¼rÃ¼n adÄ±\"\n   â†’ needs_sheets_query: TRUE\n   â†’ next_state: \"idle\"`\n   }\n\nðŸ“Œ \"appointment\": Randevu talebi\n   \n   ${!calendarEnabled ? \n   `ðŸ”´ GOOGLE CALENDAR YOK!\n   â†’ response: \"Randevu iÃ§in lÃ¼tfen bizimle direkt iletiÅŸime geÃ§ebilirsiniz.\"\n   â†’ needs_calendar_check: FALSE\n   â†’ next_state: \"idle\"` \n   : \n   `âœ… GOOGLE CALENDAR AKTÄ°F\n   \n   EÄžER state=\"idle\" ve tarih/saat YOK:\n   â†’ response: \"Tabii, hangi tarih ve saatte randevu almak istersiniz?\"\n   â†’ next_state: \"awaiting_appointment_date\"\n   â†’ needs_calendar_check: FALSE\n   \n   EÄžER tarih VAR ama saat YOK:\n   â†’ response: \"Hangi saatte randevu istersiniz?\"\n   â†’ next_state: \"awaiting_appointment_time\"\n   â†’ needs_calendar_check: FALSE\n   \n   EÄžER hem tarih hem saat VAR:\n   â†’ response: \"\" (BOÅž!)\n   â†’ metadata.date: \"YYYY-MM-DD\"\n   â†’ metadata.time: \"HH:MM\"\n   â†’ needs_calendar_check: TRUE\n   â†’ next_state: \"awaiting_confirmation\"`\n   }\n\nðŸ“Œ \"product_info\": ÃœrÃ¼n bilgisi\n   â†’ price_query ile AYNI mantÄ±k\n\nðŸ“Œ \"complaint\": Åžikayet\n   â†’ SEN DOÄžRUDAN CEVAP VER\n   â†’ Destek ekibine yÃ¶nlendir\n   â†’ next_state: \"idle\"\n`;\n\n// ============================================================\n// TAM PROMPT OLUÅžTUR\n// ============================================================\n\nconst fullPrompt = `${data.ai_system_prompt || 'Sen yardÄ±mcÄ± bir AI asistansÄ±n.'}\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nÅžÄ°RKET BÄ°LGÄ°LERÄ°\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nÅžirket: ${data.company_name || 'Bilinmiyor'}\nKarÅŸÄ±lama: ${data.company_greeting || 'Merhaba!'}\nKiÅŸilik: ${data.personality || 'friendly'}\n\n${userTypeSection}\n\n${featuresSection}\n\n${languageSection}\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nTARÄ°H VE ZAMAN\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nTarih: ${data.current_date || 'Bilinmiyor'}\nGÃ¼n: ${data.day_of_week || 'Bilinmiyor'}\nSaat: ${data.current_hour || '?'}:${data.current_minute || '?'}\nZaman: ${data.time_of_day || 'Bilinmiyor'}\n\n${stateSection}\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nKONUÅžMA GEÃ‡MÄ°ÅžÄ° (SON 10 MESAJ)\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n${data.context || '(HenÃ¼z mesaj yok)'}\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nSON KULLANICI MESAJI (CEVAP VERECEÄžÄ°N)\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n${data.current_message}\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nTALÄ°MATLAR\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n1. KullanÄ±cÄ± mesajÄ±nÄ± analiz et\n2. Dili tespit et\n3. Conversation state'e dikkat et\n4. Intent'i belirle\n5. Entegrasyon durumuna gÃ¶re davran\n\n${intentSection}\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nCEVAP FORMATI (SADECE JSON!)\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n{\n  \"detected_language\": \"tr\",\n  \"detected_intent\": \"general_chat\",\n  \"confidence\": 0.85,\n  \"action\": \"general_response\",\n  \"next_state\": \"idle\",\n  \"response\": \"KullanÄ±cÄ±ya sÃ¶ylenecek (general_chat veya reddetme iÃ§in DOLU, sheets/calendar iÃ§in BOÅž)\",\n  \"needs_sheets_query\": false,\n  \"needs_calendar_check\": false,\n  \"ready_to_execute\": false,\n  \"collected_data\": {},\n  \"metadata\": {}\n}\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nKRÄ°TÄ°K KURALLAR\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nâœ… SADECE JSON DÃ–NDÃœR!\nâœ… Sheets/Calendar yoksa needs_*_query=FALSE + kibarca reddet\nâœ… VIP user'a detaylÄ± bilgi ver\nâœ… State'e gÃ¶re davran\nâœ… response: general_chat veya reddetme iÃ§in DOLU, sistem Ã§aÄŸrÄ±larÄ± iÃ§in BOÅž\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`;\n\n// ============================================================\n// RETURN\n// ============================================================\n\nreturn {\n  json: {\n    ...data,\n    gemini_prompt: fullPrompt,\n    \n    // Debug bilgileri\n    sheets_enabled: sheetsEnabled,\n    calendar_enabled: calendarEnabled,\n    prompt_length: fullPrompt.length,\n    prompt_generated_at: new Date().toISOString()\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6912,
        -544
      ],
      "id": "d909b617-4680-4015-acfd-e2d67a0dd5c6",
      "name": "Build Gemini Prompt"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://rlrnurzpeanloppntldg.supabase.co/rest/v1/rpc/get_primary_calendar_for_intent",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJscm51cnpwZWFubG9wcG50bGRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAyMDY5NTYsImV4cCI6MjA3NTc4Mjk1Nn0.d50ICp_1Rgg57c3kUCeZfTM86qZegaWXv56mQLAX6UQ"
            },
            {
              "name": "Authorization",
              "value": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJscm51cnpwZWFubG9wcG50bGRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAyMDY5NTYsImV4cCI6MjA3NTc4Mjk1Nn0.d50ICp_1Rgg57c3kUCeZfTM86qZegaWXv56mQLAX6UQ"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "p_company_id",
              "value": "={{ $('Parse Gemini Response').item.json.company_id }}"
            },
            {
              "name": "p_intent",
              "value": "appointment"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        8448,
        -544
      ],
      "id": "a4d86274-ab4f-43fd-ae91-816e93dc9e9e",
      "name": "Get Primary Calendar"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "a90dd80a-3e2c-4e2e-b736-2a3ae87fa47e",
              "leftValue": "={{ $json[0].google_calendar_id }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        8688,
        -544
      ],
      "id": "b3c6986c-2764-4371-9851-2dfb4fc83f81",
      "name": "Check Calendar Exists"
    },
    {
      "parameters": {
        "jsCode": "// Calendar bilgilerini parse et\nconst calendarData = $input.first().json[0];\nconst geminiData = $('Parse Gemini Response').first().json;\n\n// KullanÄ±cÄ±dan toplanan bilgiler\nconst requestedDate = geminiData.intent_metadata?.date || geminiData.collected_data?.appointment_date;\nconst requestedTime = geminiData.intent_metadata?.time || geminiData.collected_data?.appointment_time;\nconst appointmentType = geminiData.intent_metadata?.appointment_type || 'appointment';\nconst customerName = geminiData.collected_data?.customer_name || geminiData.sender_name;\nconst reason = geminiData.collected_data?.reason || 'Randevu talebi';\n\n// Tarih ve saat formatla\nconst dateTime = `${requestedDate}T${requestedTime}:00`;\nconst startDateTime = new Date(dateTime).toISOString();\n\n// BitiÅŸ zamanÄ± (varsayÄ±lan 1 saat)\nconst endDateTime = new Date(new Date(dateTime).getTime() + 60 * 60 * 1000).toISOString();\n\nreturn {\n  json: {\n    ...geminiData,\n    \n    // Calendar bilgileri\n    calendar_id: calendarData.calendar_id,\n    google_calendar_id: calendarData.google_calendar_id,\n    calendar_name: calendarData.calendar_name,\n    timezone: calendarData.timezone || 'Europe/Istanbul',\n    \n    // Randevu bilgileri\n    requested_date: requestedDate,\n    requested_time: requestedTime,\n    start_datetime: startDateTime,\n    end_datetime: endDateTime,\n    appointment_type: appointmentType,\n    customer_name: customerName,\n    reason: reason,\n    \n    // Event iÃ§in\n    event_summary: `${appointmentType}: ${customerName}`,\n    event_description: `MÃ¼ÅŸteri: ${customerName}\\nTelefon: ${geminiData.phone_number}\\nSebep: ${reason}`\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        8992,
        -752
      ],
      "id": "a4d06b85-5af3-42ca-9379-f36a51bd5a1b",
      "name": "Parse Calendar Info"
    },
    {
      "parameters": {
        "url": "=https://www.googleapis.com/calendar/v3/calendars/{{ encodeURIComponent($json.google_calendar_id) }}/events?timeMin={{ encodeURIComponent($json.start_datetime) }}&timeMax={{ encodeURIComponent($json.end_datetime) }}&singleEvents=true",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "googleApi",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "timeMin",
              "value": "={{ $json.start_datetime }}"
            },
            {
              "name": "timeMax",
              "value": "={{ $json.end_datetime }}"
            },
            {
              "name": "SingleEvents",
              "value": "true"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        9248,
        -752
      ],
      "id": "06cb6d58-d536-4a2a-be85-6c2ae09ea395",
      "name": "Check Calendar Availability",
      "credentials": {
        "googleApi": {
          "id": "d9uNsv6UUdhTsb6Z",
          "name": "Google Service Account account"
        }
      },
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "84e6c59f-3ded-4b26-ba1b-5fd4f5b20729",
              "leftValue": "={{ $json.items }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "empty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        9728,
        -768
      ],
      "id": "58cfcba1-0d66-4375-8d97-3c32a4aa6114",
      "name": "Is Available?"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://www.googleapis.com/calendar/v3/calendars/{{ encodeURIComponent($('Parse Calendar Info').item.json.google_calendar_id) }}/events",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "googleApi",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{\n  {\n    \"summary\": $('Parse Calendar Info').item.json.event_summary,\n    \"description\": $('Parse Calendar Info').item.json.event_description,\n    \"start\": {\n      \"dateTime\": $('Parse Calendar Info').item.json.start_datetime,\n      \"timeZone\": $('Parse Calendar Info').item.json.timezone\n    },\n    \"end\": {\n      \"dateTime\": $('Parse Calendar Info').item.json.end_datetime,\n      \"timeZone\": $('Parse Calendar Info').item.json.timezone\n    },\n    \"attendees\": [\n      {\n        \"email\": $('Parse Calendar Info').item.json.phone_number + \"@whatsapp.com\",\n        \"displayName\": $('Parse Calendar Info').item.json.customer_name\n      }\n    ],\n    \"reminders\": {\n      \"useDefault\": false,\n      \"overrides\": [\n        { \"method\": \"popup\", \"minutes\": 30 }\n      ]\n    }\n  }\n}}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        10000,
        -864
      ],
      "id": "26ca9572-78a3-4e3d-9380-57b27acbf072",
      "name": "HTTP Request2",
      "credentials": {
        "googleApi": {
          "id": "d9uNsv6UUdhTsb6Z",
          "name": "Google Service Account account"
        }
      }
    },
    {
      "parameters": {
        "tableId": "appointment_requests",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "company_id",
              "fieldValue": "={{ $('Parse Calendar Info').item.json.company_id }}"
            },
            {
              "fieldId": "customer_phone",
              "fieldValue": "={{ $('Parse Calendar Info').item.json.phone_number }}"
            },
            {
              "fieldId": "customer_name",
              "fieldValue": "={{ $('Parse Calendar Info').item.json.customer_name }}"
            },
            {
              "fieldId": "whatsapp_session_id",
              "fieldValue": "={{ $('Parse Calendar Info').item.json.session_id }}"
            },
            {
              "fieldId": "whatsapp_customer_id",
              "fieldValue": "={{ $('Parse Calendar Info').item.json.user_id }}"
            },
            {
              "fieldId": "requested_date",
              "fieldValue": "={{ $('Parse Calendar Info').item.json.requested_date }}"
            },
            {
              "fieldId": "requested_time",
              "fieldValue": "={{ $('Parse Calendar Info').item.json.requested_time }}"
            },
            {
              "fieldId": "appointment_type",
              "fieldValue": "={{ $('Parse Calendar Info').item.json.appointment_type }}"
            },
            {
              "fieldId": "appointment_reason",
              "fieldValue": "={{ $('Parse Calendar Info').item.json.reason }}"
            },
            {
              "fieldId": "duration_minutes",
              "fieldValue": "=60"
            },
            {
              "fieldId": "status",
              "fieldValue": "confirmed"
            },
            {
              "fieldId": "google_event_id",
              "fieldValue": "={{ $json.id }}"
            },
            {
              "fieldId": "calendar_instance_id",
              "fieldValue": "={{ $('Parse Calendar Info').item.json.calendar_id }}"
            },
            {
              "fieldId": "created_via",
              "fieldValue": "whatsapp"
            },
            {
              "fieldId": "ai_parsed_data",
              "fieldValue": "={{ JSON.stringify($('Parse Calendar Info').item.json.collected_data) }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        10288,
        -864
      ],
      "id": "ad9f860d-e57e-47d9-920f-e760482c54bc",
      "name": "Save Appointment",
      "credentials": {
        "supabaseApi": {
          "id": "SYQY7Y5p1hnytb5L",
          "name": "Supabase account 2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const calendarData = $('Parse Calendar Info').first().json;\nconst eventData = $('Create Calendar Event').first().json;\n\nconst date = new Date(calendarData.start_datetime);\nconst dateStr = date.toLocaleDateString('tr-TR', { \n  day: 'numeric', \n  month: 'long', \n  year: 'numeric' \n});\nconst timeStr = date.toLocaleTimeString('tr-TR', { \n  hour: '2-digit', \n  minute: '2-digit' \n});\n\nconst successMessage = `âœ… Randevunuz oluÅŸturuldu!\n\nðŸ“… Tarih: ${dateStr}\nðŸ• Saat: ${timeStr}\nðŸ“ Randevu TÃ¼rÃ¼: ${calendarData.appointment_type}\n\nRandevunuz onaylanmÄ±ÅŸtÄ±r. 30 dakika Ã¶ncesinden hatÄ±rlatma alacaksÄ±nÄ±z.\n\nTeÅŸekkÃ¼r ederiz! ðŸ™`;\n\nreturn {\n  json: {\n    ...calendarData,\n    bot_response: successMessage,\n    event_id: eventData.id,\n    event_link: eventData.htmlLink\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        10640,
        -864
      ],
      "id": "a15c15b2-ff27-4bc4-ab0c-1b687fda9eec",
      "name": "Format Success Response"
    },
    {
      "parameters": {
        "jsCode": "const calendarData = $('Parse Calendar Info').first().json;\nconst busyEvents = $('Check Calendar Availability').first().json.items || [];\n\nconst date = new Date(calendarData.start_datetime);\nconst dateStr = date.toLocaleDateString('tr-TR', { \n  day: 'numeric', \n  month: 'long' \n});\nconst timeStr = date.toLocaleTimeString('tr-TR', { \n  hour: '2-digit', \n  minute: '2-digit' \n});\n\nconst unavailableMessage = `âŒ ÃœzgÃ¼nÃ¼m, ${dateStr} tarihinde saat ${timeStr} iÃ§in randevu mÃ¼sait deÄŸil.\n\nLÃ¼tfen farklÄ± bir tarih veya saat belirtin.\n\nÃ–rnek: \"YarÄ±n saat 14:00\" veya \"20 KasÄ±m saat 10:00\"`;\n\nreturn {\n  json: {\n    ...calendarData,\n    bot_response: unavailableMessage,\n    next_state: 'awaiting_appointment_date'\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        10480,
        -640
      ],
      "id": "1626e655-7124-4281-b08b-faacd25dbe5c",
      "name": "Slot Unavaiblable Response"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        11072,
        -848
      ],
      "id": "4c7b3a31-38c6-4e87-82b5-d147b0296a30",
      "name": "Merge Calendar Responses"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "d8689ffb-0baf-43bd-b430-ab58b9b0c89e",
              "name": "ai_response",
              "value": "={{ $json.bot_response }}",
              "type": "string"
            },
            {
              "id": "070fd0ff-8693-480f-8aa4-1592eead46a1",
              "name": "user_message_id",
              "value": "={{ $now.toString() + '_user' }}",
              "type": "string"
            },
            {
              "id": "ebf8a6af-f34e-41ce-a8ec-bff005182480",
              "name": "bot_message_id",
              "value": "={{ $now.toString() + '_bot' }}",
              "type": "string"
            },
            {
              "id": "e1d7c46b-91e9-49d4-b0b9-e507957ae72f",
              "name": "session_id",
              "value": "={{ $('Context Builder').item.json.session_id }}",
              "type": "string"
            },
            {
              "id": "4c7e5517-aac3-4a3f-bd83-1322fcdfa599",
              "name": "user_id",
              "value": "={{ $('Context Builder').item.json.user_id }}",
              "type": "string"
            },
            {
              "id": "cf9769ee-1600-4f85-bc28-640a5e541afc",
              "name": "instance_id",
              "value": "={{ $('Context Builder').item.json.instance_id }}",
              "type": "string"
            },
            {
              "id": "05ef1d33-ef6e-4d9d-a096-01d8e4d2f35c",
              "name": "phone_number",
              "value": "={{ $('Context Builder').item.json.phone_number }}",
              "type": "string"
            },
            {
              "id": "b93cd87a-0916-416f-a3e7-3ed545b736fd",
              "name": "company_id",
              "value": "={{ $('Context Builder').item.json.company_id }}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        11328,
        -720
      ],
      "id": "3bfa8c64-4dfd-4173-8c31-b7b354108dfd",
      "name": "Format Calendar Response"
    },
    {
      "parameters": {
        "tableId": "whatsapp_messages",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "sender",
              "fieldValue": "=bot"
            },
            {
              "fieldId": "sender_name",
              "fieldValue": "agent"
            },
            {
              "fieldId": "message_body",
              "fieldValue": "={{ $json.ai_response }}"
            },
            {
              "fieldId": "message_owner",
              "fieldValue": "bot"
            },
            {
              "fieldId": "message_type",
              "fieldValue": "text"
            },
            {
              "fieldId": "instance_id",
              "fieldValue": "={{ $json.instance_id }}"
            },
            {
              "fieldId": "created_at",
              "fieldValue": "={{ new Date().toISOString() }}"
            },
            {
              "fieldId": "user_id",
              "fieldValue": "={{ $json.user_id.toString() }}"
            },
            {
              "fieldId": "session_id",
              "fieldValue": "={{ $json.session_id.toString() }}"
            },
            {
              "fieldId": "company_id",
              "fieldValue": "={{ $('Inject IDs').item.json.company_id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        11504,
        -720
      ],
      "id": "4b9e573a-b99e-4b8b-8182-4814a464fd9d",
      "name": "Save Calendar Bot Response",
      "credentials": {
        "supabaseApi": {
          "id": "SYQY7Y5p1hnytb5L",
          "name": "Supabase account 2"
        }
      },
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('Context Builder').item.json.evolution_api_url }}message/sendText/{{ $('Context Builder').item.json.instance_name }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{ $('Context Builder').item.json.evolution_api_key }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "number",
              "value": "={{ $('Format Response2').item.json.phone_number }}"
            },
            {
              "name": "text",
              "value": "={{ $('Format Response2').item.json.ai_response }}"
            },
            {
              "name": "delay",
              "value": "={{ 1000 }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        11760,
        -736
      ],
      "id": "58979999-58d6-4deb-94f1-c5d77785ee55",
      "name": "Send Calendar Response"
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "user_profiles",
        "filters": {
          "conditions": [
            {
              "keyName": "phone_number",
              "condition": "eq",
              "keyValue": "={{ $('Context Builder').item.json.phone_number }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "last_seen",
              "fieldValue": "={{ new Date().toISOString() }}"
            },
            {
              "fieldId": "total_messages",
              "fieldValue": "={{ parseInt($json.total_messages || 0) + 1 }}"
            },
            {
              "fieldId": "customer_status",
              "fieldValue": "={{ parseInt($json.total_messages || 0) >= 4 ? \"old\" : \"new\" }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        12400,
        -736
      ],
      "id": "06d8b9ed-019e-4e35-accf-0d7772e474b5",
      "name": "Update Calendar User Stats",
      "credentials": {
        "supabaseApi": {
          "id": "YWr0zYtmMCKrbiNV",
          "name": "Supabase account"
        }
      },
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        13056,
        -768
      ],
      "id": "ac28e55c-3d7c-4540-9b48-3b3f863852ed",
      "name": "Calendar Flow Complete"
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "whatsapp_sessions",
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "keyName": "id",
              "condition": "eq",
              "keyValue": "=={{ $('Context Builder').item.json.session_id }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "context",
              "fieldValue": "={{ JSON.stringify({ last_message: $json.ai_response, user_name: $json.sender_name }) }}"
            },
            {
              "fieldId": "updated_at",
              "fieldValue": "={{ new Date().toISOString() }}"
            },
            {
              "fieldId": "is_active",
              "fieldValue": "=true"
            },
            {
              "fieldId": "session_end",
              "fieldValue": "={{ new Date(Date.now() + 1800000).toISOString() }}"
            },
            {
              "fieldId": "conversation_state",
              "fieldValue": "={{ $('Format Calendar Response').item.json.next_state || 'idle' }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        12720,
        -752
      ],
      "id": "bdf693d6-de1f-4883-8ffe-0b2015ffc0b1",
      "name": "Update Calendar Session",
      "alwaysOutputData": false,
      "credentials": {
        "supabaseApi": {
          "id": "SYQY7Y5p1hnytb5L",
          "name": "Supabase account 2"
        }
      },
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "jsCode": "const geminiData = $('Parse Gemini Response').first().json;\n\nconst unavailableMessage = `ÃœzgÃ¼nÃ¼m, randevu sistemi ÅŸu an aktif deÄŸil.\n\nRandevu almak iÃ§in lÃ¼tfen bizimle direkt iletiÅŸime geÃ§ebilirsiniz:\nðŸ“ž Telefon: [TELEFON]\nðŸ“§ Email: [EMAIL]\n\nSize yardÄ±mcÄ± olmak iÃ§in buradayÄ±z! ðŸ™`;\n\nreturn {\n  json: {\n    ...geminiData,\n    bot_response: unavailableMessage,\n    next_state: 'idle'\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        9680,
        -16
      ],
      "id": "e98c6def-e1db-4a76-86b8-7de58191c256",
      "name": "Calendar Not Available Reponse"
    },
    {
      "parameters": {
        "jsCode": "const error = $input.first().json;\nconst contextData = $('Context Builder').first().json;\n\n// Error'u logla\nconst errorLog = {\n  company_id: contextData.company_id,\n  instance_id: contextData.instance_id,\n  error_type: 'gemini_api_error',\n  error_message: error.message || 'Gemini API failed',\n  error_details: JSON.stringify(error),\n  node_name: 'Gemini API (Dynamic)',\n  user_id: contextData.user_id,\n  session_id: contextData.session_id,\n  phone_number: contextData.phone_number,\n  severity: 'error'\n};\n\n// Fallback response\nconst fallbackResponse = {\n  detected_language: 'tr',\n  detected_intent: 'error',\n  confidence: 0,\n  next_state: 'idle',\n  bot_response: 'ÃœzgÃ¼nÃ¼m, ÅŸu anda teknik bir sorun yaÅŸÄ±yorum. LÃ¼tfen birkaÃ§ saniye sonra tekrar deneyin.',\n  needs_sheets_query: false,\n  needs_calendar_check: false,\n  collected_data: {},\n  metadata: { error: true }\n};\n\nreturn [{\n  json: {\n    ...contextData,\n    error_log: errorLog,\n    gemini_fallback: true,\n    ai_response: fallbackResponse,\n    bot_response: fallbackResponse.bot_response,\n    detected_intent: 'error',\n    next_state: 'idle'\n  }\n}]"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        7376,
        112
      ],
      "id": "5a4c939a-dae4-4420-9af7-5cefb0fa8ab2",
      "name": "Gemini Error Handler"
    },
    {
      "parameters": {
        "tableId": "whatsapp_errors",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "company_id",
              "fieldValue": "={{ $json.error_log.company_id }}"
            },
            {
              "fieldId": "instance_id",
              "fieldValue": "={{ $json.error_log.instance_id }}"
            },
            {
              "fieldId": "error_type",
              "fieldValue": "={{ $json.error_log.error_type }}"
            },
            {
              "fieldId": "error_message",
              "fieldValue": "={{ $json.error_log.error_message }}"
            },
            {
              "fieldId": "error_details",
              "fieldValue": "={{ $json.error_log.error_details }}"
            },
            {
              "fieldId": "node_name",
              "fieldValue": "={{ $json.error_log.node_name }}"
            },
            {
              "fieldId": "user_id",
              "fieldValue": "={{ $json.error_log.user_id }}"
            },
            {
              "fieldId": "session_id",
              "fieldValue": "={{ $json.error_log.session_id }}"
            },
            {
              "fieldId": "phone_number",
              "fieldValue": "={{ $json.error_log.phone_number }}"
            },
            {
              "fieldId": "severity",
              "fieldValue": "={{ $json.error_log.severity }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        7696,
        112
      ],
      "id": "605ad316-ef89-423e-92e8-e4e9a318349c",
      "name": "Log Gemini Error",
      "credentials": {
        "supabaseApi": {
          "id": "SYQY7Y5p1hnytb5L",
          "name": "Supabase account 2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const data = $input.first().json;\n\n// Webhook'tan gelen data\nconst webhook = $('Webhook_Listener').first().json;\nconst remoteJid = webhook.body.data.key.remoteJid;\nconst phoneNumber = remoteJid.replace('@s.whatsapp.net', '');\nconst instanceId = webhook.body.instance;\n\n// Åžu anki zaman\nconst now = new Date();\nconst oneMinuteAgo = new Date(now.getTime() - 60000); // 1 dakika Ã¶nce\n\nreturn [{\n  json: {\n    phone_number: phoneNumber,\n    instance_id: instanceId,\n    check_time: now.toISOString(),\n    window_start: oneMinuteAgo.toISOString()\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1424,
        -32
      ],
      "id": "858a17a8-9c89-4839-bd2e-07de613b05cc",
      "name": "Check Rate Limit"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "310cd110-3685-4ef9-b3fd-c8f74adaad6e",
              "leftValue": "={{ $json.length > 0 && ($json[0].message_count || 0) >= 10 }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -800,
        -32
      ],
      "id": "df5fe8cc-a834-4799-93dd-77070e3e3732",
      "name": "Evaluate Rate Limit"
    },
    {
      "parameters": {
        "jsCode": "const rateData = $input.first().json[0];\n\nreturn [{\n  json: {\n    is_spam: true,\n    phone_number: rateData.user_phone,\n    message_count: rateData.message_count,\n    bot_response: 'âš ï¸ Ã‡ok hÄ±zlÄ± mesaj gÃ¶nderiyorsunuz. LÃ¼tfen 1 dakika bekleyip tekrar deneyin.',\n    block_until: new Date(Date.now() + 60000).toISOString() // 1 dakika block\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -592,
        -368
      ],
      "id": "f3c4c5e0-bb51-45dd-a95e-71b99e0f88f0",
      "name": "Block User Response"
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "rate_limits",
        "returnAll": true,
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "keyName": "user_phone",
              "condition": "eq",
              "keyValue": "={{ $json.phone_number }}"
            },
            {
              "keyName": "window_start",
              "condition": "gte",
              "keyValue": "={{ $json.window_start }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -1088,
        -32
      ],
      "id": "d555ed96-fdad-43ce-b11d-baee73a48fb3",
      "name": "Get Rate Limit1",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "SYQY7Y5p1hnytb5L",
          "name": "Supabase account 2"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "410afd0f-4956-4f82-9231-3b1cd1ec9310",
              "leftValue": "={{ $json.length > 0 }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -512,
        -16
      ],
      "id": "e07522ae-4342-4bcb-a2b4-1b9da63ddf74",
      "name": "Rate Limit Exists?"
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "rate_limits",
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "keyName": "user_phone",
              "condition": "eq",
              "keyValue": "={{ $('Check Rate Limit').item.json.phone_number }}"
            },
            {
              "keyName": "window_start",
              "condition": "gte",
              "keyValue": "={{ $('Check Rate Limit').item.json.window_start }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "message_count",
              "fieldValue": "={{ $json[0].message_count + 1 }}"
            },
            {
              "fieldId": "updated_at",
              "fieldValue": "={{ $now }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -256,
        -176
      ],
      "id": "34c900ac-885e-475e-a10b-75d5bd678b2d",
      "name": "Update Rate Limit",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "SYQY7Y5p1hnytb5L",
          "name": "Supabase account 2"
        }
      }
    },
    {
      "parameters": {
        "tableId": "rate_limits",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "company_id",
              "fieldValue": "={{ $('Get Company & Instance').first().json.company_id }}"
            },
            {
              "fieldId": "user_phone",
              "fieldValue": "={{ $('Check Rate Limit').item.json.phone_number }}"
            },
            {
              "fieldId": "message_count",
              "fieldValue": "1"
            },
            {
              "fieldId": "window_start",
              "fieldValue": "={{ $('Check Rate Limit').item.json.window_start }}"
            },
            {
              "fieldId": "is_blocked",
              "fieldValue": "false"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -272,
        176
      ],
      "id": "f0cc9ae4-dafb-4ba8-a844-f8932653e26c",
      "name": "Create Rate Limit",
      "credentials": {
        "supabaseApi": {
          "id": "SYQY7Y5p1hnytb5L",
          "name": "Supabase account 2"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        32,
        -32
      ],
      "id": "5f100245-241c-4edb-8e61-642f17c6325a",
      "name": "Merge1"
    },
    {
      "parameters": {
        "respondWith": "text",
        "responseBody": "OK",
        "options": {
          "responseCode": 200
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        -352,
        -368
      ],
      "id": "e45ff9bc-f73c-4fe6-be92-a2b37bbeb268",
      "name": "Respond to Webhook1"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "fd5c5026-0de3-48f5-9c0d-3e03e4e52dec",
              "leftValue": "={{ $json.intent_confidence >= 0.6 }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        7792,
        -560
      ],
      "id": "f5f9c22f-0f34-4d21-b182-022fc2006696",
      "name": "Check Intent Confidence"
    },
    {
      "parameters": {
        "tableId": "failed_intents",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "company_id",
              "fieldValue": "={{ $('Context Builder').item.json.company_id }}"
            },
            {
              "fieldId": "session_id",
              "fieldValue": "={{ $('Context Builder').item.json.session_id }}"
            },
            {
              "fieldId": "user_message",
              "fieldValue": "={{ $('Context Builder').item.json.current_message }}"
            },
            {
              "fieldId": "detected_intent",
              "fieldValue": "={{ $json.detected_intent }}"
            },
            {
              "fieldId": "confidence",
              "fieldValue": "={{ $json.intent_confidence }}"
            },
            {
              "fieldId": "gemini_response",
              "fieldValue": "={{ JSON.stringify($json.ai_response) }}"
            },
            {
              "fieldId": "human_review_needed",
              "fieldValue": "true"
            },
            {
              "fieldId": "resolved",
              "fieldValue": "false"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        7440,
        -144
      ],
      "id": "0607cbff-634d-46e2-9239-89fdf3b5fcbe",
      "name": "Log Failed Intent",
      "credentials": {
        "supabaseApi": {
          "id": "SYQY7Y5p1hnytb5L",
          "name": "Supabase account 2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const data = $input.first().json;\nconst contextData = $('Context Builder').first().json;\n\nreturn [{\n  json: {\n    ...contextData,\n    bot_response: 'ÃœzgÃ¼nÃ¼m, tam anlayamadÄ±m. Size daha iyi yardÄ±mcÄ± olmak iÃ§in bir temsilcimizle gÃ¶rÃ¼ÅŸÃ¼r mÃ¼sÃ¼nÃ¼z? ðŸ™',\n    ai_response: 'ÃœzgÃ¼nÃ¼m, tam anlayamadÄ±m. Size daha iyi yardÄ±mcÄ± olmak iÃ§in bir temsilcimizle gÃ¶rÃ¼ÅŸÃ¼r mÃ¼sÃ¼nÃ¼z? ðŸ™',\n    session_id: contextData.session_id,\n    user_id: contextData.user_id,\n    instance_id: contextData.instance_id,\n    phone_number: contextData.phone_number,\n    company_id: contextData.company_id\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        7696,
        -144
      ],
      "id": "54be8051-0d14-4bf3-9733-e15d988d2c76",
      "name": "Human Fallback Response"
    },
    {
      "parameters": {
        "jsCode": "const data = $input.first().json;\nconst geminiData = $('Parse Gemini Response').first().json;\nconst contextData = $('Context Builder').first().json;\n\n// BugÃ¼nÃ¼n tarihi\nconst today = new Date().toISOString().split('T')[0];\n\n// Intent sayÄ±sÄ±nÄ± hesapla\nconst intentType = geminiData.detected_intent || 'general_chat';\nconst intentCounts = {\n  intent_general_chat: intentType === 'general_chat' ? 1 : 0,\n  intent_price_query: intentType === 'price_query' ? 1 : 0,\n  intent_appointment: intentType === 'appointment' ? 1 : 0,\n  intent_product_info: intentType === 'product_info' ? 1 : 0,\n  intent_complaint: intentType === 'complaint' ? 1 : 0\n};\n\n// Sheets/Calendar success mi?\nconst sheetsSuccess = geminiData.needs_sheets_query && !geminiData.error ? 1 : 0;\nconst calendarSuccess = geminiData.needs_calendar_check && !geminiData.error ? 1 : 0;\n\nreturn [{\n  json: {\n    ...data,\n    analytics: {\n      company_id: contextData.company_id,\n      date: today,\n      total_messages: 2, // 1 user + 1 bot\n      user_messages: 1,\n      bot_messages: 1,\n      unique_users: 1,\n      ...intentCounts,\n      sheets_queries: geminiData.needs_sheets_query ? 1 : 0,\n      sheets_success: sheetsSuccess,\n      calendar_bookings: geminiData.needs_calendar_check ? 1 : 0,\n      calendar_success: calendarSuccess,\n      gemini_errors: 0,\n      sheets_errors: 0,\n      calendar_errors: 0\n    }\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        9680,
        352
      ],
      "id": "ad18205a-e250-4947-ad8a-8d0932e6888c",
      "name": "Log Analytics"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://rlrnurzpeanloppntldg.supabase.co/rest/v1/rpc/increment_analytics",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJscm51cnpwZWFubG9wcG50bGRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAyMDY5NTYsImV4cCI6MjA3NTc4Mjk1Nn0.d50ICp_1Rgg57c3kUCeZfTM86qZegaWXv56mQLAX6UQ"
            },
            {
              "name": "Authorization",
              "value": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJscm51cnpwZWFubG9wcG50bGRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAyMDY5NTYsImV4cCI6MjA3NTc4Mjk1Nn0.d50ICp_1Rgg57c3kUCeZfTM86qZegaWXv56mQLAX6UQ"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.analytics }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        10032,
        352
      ],
      "id": "2e1aac69-c970-4a4f-8a57-dd1a7d949e5c",
      "name": "Upsert Analytics",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "const error = $input.first().json;\nconst contextData = $('Context Builder').first().json;\n\nconst errorLog = {\n  company_id: contextData.company_id,\n  instance_id: contextData.instance_id,\n  error_type: 'sheets_api_error',\n  error_message: error.message || 'Google Sheets API failed',\n  error_details: JSON.stringify(error),\n  node_name: 'Get Sheet Data',\n  user_id: contextData.user_id,\n  session_id: contextData.session_id,\n  phone_number: contextData.phone_number,\n  severity: 'error'\n};\n\nconst fallbackResponse = {\n  bot_response: 'ÃœzgÃ¼nÃ¼m, Ã¼rÃ¼n bilgilerini ÅŸu anda getiremiyorum. LÃ¼tfen birkaÃ§ saniye sonra tekrar deneyin.',\n  sheets_error: true\n};\n\nreturn [{\n  json: {\n    ...contextData,\n    error_log: errorLog,\n    bot_response: fallbackResponse.bot_response,\n    session_id: contextData.session_id,\n    user_id: contextData.user_id,\n    instance_id: contextData.instance_id,\n    phone_number: contextData.phone_number,\n    company_id: contextData.company_id\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        9408,
        -1408
      ],
      "id": "f5e97c6c-4935-4812-a602-9f503d73f3b8",
      "name": "Sheets Error Handler"
    },
    {
      "parameters": {
        "tableId": "whatsapp_errors",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "company_id",
              "fieldValue": "={{ $json.error_log.company_id }}"
            },
            {
              "fieldId": "instance_id",
              "fieldValue": "={{ $json.error_log.instance_id }}"
            },
            {
              "fieldId": "error_type",
              "fieldValue": "={{ $json.error_log.error_type }}"
            },
            {
              "fieldId": "error_message",
              "fieldValue": "={{ $json.error_log.error_message }}"
            },
            {
              "fieldId": "error_details",
              "fieldValue": "={{ $json.error_log.error_details }}"
            },
            {
              "fieldId": "node_name",
              "fieldValue": "={{ $json.error_log.node_name }}"
            },
            {
              "fieldId": "user_id",
              "fieldValue": "={{ $json.error_log.user_id }}"
            },
            {
              "fieldId": "session_id",
              "fieldValue": "={{ $json.error_log.session_id }}"
            },
            {
              "fieldId": "phone_number",
              "fieldValue": "={{ $json.error_log.phone_number }}"
            },
            {
              "fieldId": "severity",
              "fieldValue": "={{ $json.error_log.severity }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        9632,
        -1408
      ],
      "id": "b50c93c0-d57f-4a0e-8e2d-c1743fa6d51b",
      "name": "Log Sheets Error",
      "credentials": {
        "supabaseApi": {
          "id": "SYQY7Y5p1hnytb5L",
          "name": "Supabase account 2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const error = $input.first().json;\nconst contextData = $('Context Builder').first().json;\n\nconst errorLog = {\n  company_id: contextData.company_id,\n  instance_id: contextData.instance_id,\n  error_type: 'calendar_api_error',\n  error_message: error.message || 'Google Calendar API failed',\n  error_details: JSON.stringify(error),\n  node_name: 'Check Calendar Availability',\n  user_id: contextData.user_id,\n  session_id: contextData.session_id,\n  phone_number: contextData.phone_number,\n  severity: 'error'\n};\n\nconst fallbackResponse = {\n  bot_response: 'ÃœzgÃ¼nÃ¼m, randevu sistemine ÅŸu anda eriÅŸemiyorum. LÃ¼tfen daha sonra tekrar deneyin veya bizimle direkt iletiÅŸime geÃ§in.',\n  calendar_error: true\n};\n\nreturn [{\n  json: {\n    ...contextData,\n    error_log: errorLog,\n    bot_response: fallbackResponse.bot_response,\n    session_id: contextData.session_id,\n    user_id: contextData.user_id,\n    instance_id: contextData.instance_id,\n    phone_number: contextData.phone_number,\n    company_id: contextData.company_id\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        9728,
        -416
      ],
      "id": "e1ee0a56-ef2e-46fa-9839-8734b42253b3",
      "name": "Calendar Error Handler"
    },
    {
      "parameters": {
        "tableId": "whatsapp_errors",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "company_id",
              "fieldValue": "={{ $json.error_log.company_id }}"
            },
            {
              "fieldId": "instance_id",
              "fieldValue": "={{ $json.error_log.instance_id }}"
            },
            {
              "fieldId": "error_type",
              "fieldValue": "={{ $json.error_log.error_type }}"
            },
            {
              "fieldId": "error_message",
              "fieldValue": "={{ $json.error_log.error_message }}"
            },
            {
              "fieldId": "error_details",
              "fieldValue": "={{ $json.error_log.error_details }}"
            },
            {
              "fieldId": "node_name",
              "fieldValue": "={{ $json.error_log.node_name }}"
            },
            {
              "fieldId": "user_id",
              "fieldValue": "={{ $json.error_log.user_id }}"
            },
            {
              "fieldId": "session_id",
              "fieldValue": "={{ $json.error_log.session_id }}"
            },
            {
              "fieldId": "phone_number",
              "fieldValue": "={{ $json.error_log.phone_number }}"
            },
            {
              "fieldId": "severity",
              "fieldValue": "={{ $json.error_log.severity }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        9920,
        -416
      ],
      "id": "55fbe28d-6150-4c71-aec8-e36c18c720e2",
      "name": "Log Calendar Error",
      "credentials": {
        "supabaseApi": {
          "id": "SYQY7Y5p1hnytb5L",
          "name": "Supabase account 2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const data = $input.first().json;\nconst geminiData = $('Parse Gemini Response').first().json;\nconst contextData = $('Context Builder').first().json;\nconst sheetsData = $('Search in Sheets').first().json;\n\n// BugÃ¼nÃ¼n tarihi\nconst today = new Date().toISOString().split('T')[0];\n\n// Sheets success mi?\nconst sheetsSuccess = sheetsData.sheets_results_count > 0 ? 1 : 0;\n\nreturn [{\n  json: {\n    ...data,\n    analytics: {\n      company_id: contextData.company_id,\n      date: today,\n      total_messages: 2,\n      user_messages: 1,\n      bot_messages: 1,\n      unique_users: 1,\n      intent_general_chat: 0,\n      intent_price_query: 1,\n      intent_appointment: 0,\n      intent_product_info: 0,\n      intent_complaint: 0,\n      sheets_queries: 1,\n      sheets_success: sheetsSuccess,\n      calendar_bookings: 0,\n      calendar_success: 0,\n      gemini_errors: 0,\n      sheets_errors: 0,\n      calendar_errors: 0\n    }\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        10704,
        -1680
      ],
      "id": "78c6689c-5f53-45a6-90cf-16bcddbdc19c",
      "name": "Log Sheets Analytics"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://rlrnurzpeanloppntldg.supabase.co/rest/v1/rpc/increment_analytics",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJscm51cnpwZWFubG9wcG50bGRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAyMDY5NTYsImV4cCI6MjA3NTc4Mjk1Nn0.d50ICp_1Rgg57c3kUCeZfTM86qZegaWXv56mQLAX6UQ"
            },
            {
              "name": "Authorization",
              "value": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJscm51cnpwZWFubG9wcG50bGRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAyMDY5NTYsImV4cCI6MjA3NTc4Mjk1Nn0.d50ICp_1Rgg57c3kUCeZfTM86qZegaWXv56mQLAX6UQ"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.analytics }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        10896,
        -1680
      ],
      "id": "7a194863-69f3-4d29-bd30-c96bb1594f22",
      "name": "Upsert Sheets Analytics",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "const data = $input.first().json;\nconst contextData = $('Context Builder').first().json;\nconst calendarData = $('Format Calendar Response').first().json;\n\n// BugÃ¼nÃ¼n tarihi\nconst today = new Date().toISOString().split('T')[0];\n\n// Calendar success mi? (event_id varsa baÅŸarÄ±lÄ±)\nconst calendarSuccess = calendarData.event_id ? 1 : 0;\n\nreturn [{\n  json: {\n    ...data,\n    analytics: {\n      company_id: contextData.company_id,\n      date: today,\n      total_messages: 2,\n      user_messages: 1,\n      bot_messages: 1,\n      unique_users: 1,\n      intent_general_chat: 0,\n      intent_price_query: 0,\n      intent_appointment: 1,\n      intent_product_info: 0,\n      intent_complaint: 0,\n      sheets_queries: 0,\n      sheets_success: 0,\n      calendar_bookings: 1,\n      calendar_success: calendarSuccess,\n      gemini_errors: 0,\n      sheets_errors: 0,\n      calendar_errors: 0\n    }\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        11968,
        -736
      ],
      "id": "6093ed68-1c54-4a9c-b97c-cb096515c4e7",
      "name": "Log Calendar Analytics"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://rlrnurzpeanloppntldg.supabase.co/rest/v1/rpc/increment_analytics",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJscm51cnpwZWFubG9wcG50bGRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAyMDY5NTYsImV4cCI6MjA3NTc4Mjk1Nn0.d50ICp_1Rgg57c3kUCeZfTM86qZegaWXv56mQLAX6UQ"
            },
            {
              "name": "Authorization",
              "value": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJscm51cnpwZWFubG9wcG50bGRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAyMDY5NTYsImV4cCI6MjA3NTc4Mjk1Nn0.d50ICp_1Rgg57c3kUCeZfTM86qZegaWXv56mQLAX6UQ"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.analytics }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        12160,
        -736
      ],
      "id": "7d17c1a6-40dd-436d-9d1c-c13b05e553ef",
      "name": "Upsert Calendar Analytics",
      "onError": "continueRegularOutput"
    }
  ],
  "pinData": {},
  "connections": {
    "Webhook_Listener": {
      "main": [
        [
          {
            "node": "FILTER",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FILTER": {
      "main": [
        [
          {
            "node": "Check Rate Limit",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch": {
      "main": [
        [
          {
            "node": "CHECK USER",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Create User",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create User": {
      "main": [
        [
          {
            "node": "Wait",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "Prepare Session Check",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Session Validator": {
      "main": [
        [
          {
            "node": "IF2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create New Session": {
      "main": [
        [
          {
            "node": "Merge2",
            "type": "main",
            "index": 1
          }
        ],
        []
      ]
    },
    "Merge2": {
      "main": [
        [
          {
            "node": "Normalize Session ID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Last Messages": {
      "main": [
        [
          {
            "node": "Inject IDs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Context Builder": {
      "main": [
        [
          {
            "node": "Build Gemini Prompt",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Response": {
      "main": [
        [
          {
            "node": "Save Bot Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save User Message": {
      "main": [
        [
          {
            "node": "Get Last Messages",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "Save Bot Response": {
      "main": [
        [
          {
            "node": "HTTP Request",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "Update User Stats": {
      "main": [
        [
          {
            "node": "Log Analytics",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "Code: Count_Items": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Session Check": {
      "main": [
        [
          {
            "node": "Debug Session Input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF2": {
      "main": [
        [
          {
            "node": "Merge2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Close Old Sessions",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Update Session": {
      "main": [
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "Close Old Sessions": {
      "main": [
        [
          {
            "node": "Create New Session",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Normalize Session ID": {
      "main": [
        [
          {
            "node": "Save User Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Session Input": {
      "main": [
        [
          {
            "node": "Check Active Session",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Session output": {
      "main": [
        [
          {
            "node": "Session Validator",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Active Session": {
      "main": [
        [
          {
            "node": "Debug Session output",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Inject IDs": {
      "main": [
        [
          {
            "node": "Context Builder",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Company & Instance": {
      "main": [
        [
          {
            "node": "DATA FORMATTER",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "DATA FORMATTER": {
      "main": [
        [
          {
            "node": "Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "CHECK USER": {
      "main": [
        [
          {
            "node": "Check Privileged User",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "Gemini API (Dynamic)": {
      "main": [
        [
          {
            "node": "Parse Gemini Response",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Gemini Error Handler",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request": {
      "main": [
        [
          {
            "node": "Update User Stats",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Gemini Response": {
      "main": [
        [
          {
            "node": "Check Intent Confidence",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Primary Sheet": {
      "main": [
        [
          {
            "node": "Check Sheet Exists",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Sheet Exists": {
      "main": [
        [
          {
            "node": "Get Sheet Data",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Code in JavaScript1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Search in Sheets": {
      "main": [
        [
          {
            "node": "Log Sheets Query",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Log Sheets Query": {
      "main": [
        [
          {
            "node": "Format Response2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Sheet Data": {
      "main": [
        [
          {
            "node": "Search in Sheets",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Sheets Error Handler",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Response2": {
      "main": [
        [
          {
            "node": "Save Bot Response2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save Bot Response2": {
      "main": [
        [
          {
            "node": "HTTP Request1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update User Stats2": {
      "main": [
        [
          {
            "node": "Update Session2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request1": {
      "main": [
        [
          {
            "node": "Log Sheets Analytics",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript1": {
      "main": [
        [
          {
            "node": "Format Response3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Response3": {
      "main": [
        [
          {
            "node": "Save Bot Response3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Evolution API - Send Text": {
      "main": [
        [
          {
            "node": "Update User Stats3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update User Stats3": {
      "main": [
        [
          {
            "node": "Update Session3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Session3": {
      "main": [
        [
          {
            "node": "Respond to Webhook3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Privileged User": {
      "main": [
        [
          {
            "node": "Code: Count_Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ACTION ROUTER": {
      "main": [
        [
          {
            "node": "Get Primary Sheet",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get Primary Calendar",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Format Response",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "Update Session2": {
      "main": [
        [
          {
            "node": "Respond to Webhook2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save Bot Response3": {
      "main": [
        [
          {
            "node": "Evolution API - Send Text",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Gemini Prompt": {
      "main": [
        [
          {
            "node": "Gemini API (Dynamic)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Primary Calendar": {
      "main": [
        [
          {
            "node": "Check Calendar Exists",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Calendar Exists": {
      "main": [
        [
          {
            "node": "Parse Calendar Info",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Calendar Not Available Reponse",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Calendar Info": {
      "main": [
        [
          {
            "node": "Check Calendar Availability",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Calendar Availability": {
      "main": [
        [
          {
            "node": "Is Available?",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Calendar Error Handler",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Is Available?": {
      "main": [
        [
          {
            "node": "HTTP Request2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Slot Unavaiblable Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request2": {
      "main": [
        [
          {
            "node": "Save Appointment",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save Appointment": {
      "main": [
        [
          {
            "node": "Format Success Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Success Response": {
      "main": [
        [
          {
            "node": "Merge Calendar Responses",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Slot Unavaiblable Response": {
      "main": [
        [
          {
            "node": "Merge Calendar Responses",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge Calendar Responses": {
      "main": [
        [
          {
            "node": "Format Calendar Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Calendar Response": {
      "main": [
        [
          {
            "node": "Save Calendar Bot Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save Calendar Bot Response": {
      "main": [
        [
          {
            "node": "Send Calendar Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Calendar Response": {
      "main": [
        [
          {
            "node": "Log Calendar Analytics",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Calendar User Stats": {
      "main": [
        [
          {
            "node": "Update Calendar Session",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Calendar Session": {
      "main": [
        [
          {
            "node": "Calendar Flow Complete",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Calendar Not Available Reponse": {
      "main": [
        [
          {
            "node": "Format Calendar Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Gemini Error Handler": {
      "main": [
        [
          {
            "node": "Log Gemini Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Log Gemini Error": {
      "main": [
        [
          {
            "node": "Format Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Rate Limit": {
      "main": [
        [
          {
            "node": "Get Rate Limit1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Evaluate Rate Limit": {
      "main": [
        [
          {
            "node": "Block User Response",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Rate Limit Exists?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Block User Response": {
      "main": [
        [
          {
            "node": "Respond to Webhook1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Rate Limit1": {
      "main": [
        [
          {
            "node": "Evaluate Rate Limit",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Rate Limit": {
      "main": [
        [
          {
            "node": "Merge1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Rate Limit Exists?": {
      "main": [
        [
          {
            "node": "Update Rate Limit",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Create Rate Limit",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create Rate Limit": {
      "main": [
        [
          {
            "node": "Merge1",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge1": {
      "main": [
        [
          {
            "node": "Get Company & Instance",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Intent Confidence": {
      "main": [
        [
          {
            "node": "ACTION ROUTER",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Log Failed Intent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Log Failed Intent": {
      "main": [
        [
          {
            "node": "Human Fallback Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Human Fallback Response": {
      "main": [
        [
          {
            "node": "Format Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Log Analytics": {
      "main": [
        [
          {
            "node": "Upsert Analytics",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Upsert Analytics": {
      "main": [
        [
          {
            "node": "Update Session",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Sheets Error Handler": {
      "main": [
        [
          {
            "node": "Log Sheets Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Log Sheets Error": {
      "main": [
        [
          {
            "node": "Format Response2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Calendar Error Handler": {
      "main": [
        [
          {
            "node": "Log Calendar Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Log Calendar Error": {
      "main": [
        [
          {
            "node": "Format Calendar Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Log Sheets Analytics": {
      "main": [
        [
          {
            "node": "Upsert Sheets Analytics",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Upsert Sheets Analytics": {
      "main": [
        [
          {
            "node": "Update User Stats2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Log Calendar Analytics": {
      "main": [
        [
          {
            "node": "Upsert Calendar Analytics",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Upsert Calendar Analytics": {
      "main": [
        [
          {
            "node": "Update Calendar User Stats",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner"
  },
  "versionId": "27ee3f1f-44eb-436f-a300-8ca21a551a9c",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "91b61f20b1f62ceb4a025525cffd2b8f60a63fe491bea802b772f51ff6d4bab9"
  },
  "id": "E6SeuSO9oifejqo1",
  "tags": []
}